<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Neurosim ‚Äì Planificador de Clases CNEB</title>
<meta name="description" content="Planificador pedag√≥gico alineado al CNEB MINEDU Per√∫ para nivel secundario">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#faf9f6;--fg:#1a2a3a;--card:#fff;--primary:#0d9488;--primary-fg:#fff;
  --secondary:#e6f5f3;--sec-fg:#0a7a70;--muted:#94a3b8;--accent:#e8920d;
  --border:#e2e8f0;--radius:12px;--shadow:0 2px 12px rgba(0,0,0,.08);
  --font:'Segoe UI',system-ui,-apple-system,sans-serif;
}
body{font-family:var(--font);background:var(--bg);color:var(--fg);line-height:1.6}
a{color:var(--primary);text-decoration:none}
button{cursor:pointer;font-family:inherit}
input,select,textarea{font-family:inherit;font-size:.95rem}

/* Auth */
.auth-page{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1rem;position:relative;overflow:hidden}
.auth-page::before{content:'';position:absolute;top:-120px;right:-120px;width:380px;height:380px;border-radius:50%;background:rgba(13,148,136,.06);filter:blur(60px)}
.auth-page::after{content:'';position:absolute;bottom:-120px;left:-120px;width:380px;height:380px;border-radius:50%;background:rgba(232,146,13,.08);filter:blur(60px)}
.auth-box{width:100%;max-width:400px;z-index:1;text-align:center}
.auth-logo{width:56px;height:56px;border-radius:16px;background:var(--primary);display:inline-flex;align-items:center;justify-content:center;color:#fff;font-size:1.6rem;font-weight:800;margin-bottom:.5rem}
.auth-box h1{font-size:2rem;font-weight:800;margin-bottom:.15rem}
.auth-box .subtitle{color:var(--primary);font-weight:600;font-size:.9rem}
.auth-box .desc{color:var(--muted);font-size:.85rem;margin:.5rem 0 2rem}
.auth-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:2rem;box-shadow:var(--shadow);text-align:left}
.auth-card h2{font-size:1.2rem;font-weight:700;margin-bottom:1.2rem;display:flex;align-items:center;gap:.5rem}
.form-group{margin-bottom:1rem}
.form-group label{display:block;font-size:.8rem;font-weight:600;margin-bottom:.3rem;color:var(--fg)}
.form-group input{width:100%;padding:.6rem .8rem;border:1px solid var(--border);border-radius:8px;outline:none;transition:border .2s}
.form-group input:focus{border-color:var(--primary)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:.4rem;padding:.65rem 1.5rem;border:none;border-radius:8px;font-weight:600;font-size:.9rem;transition:all .2s}
.btn-primary{background:var(--primary);color:var(--primary-fg);width:100%}
.btn-primary:hover{opacity:.9}
.btn-primary:disabled{opacity:.5;cursor:not-allowed}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--fg);width:100%}
.btn-outline:hover{background:var(--secondary)}
.btn-sm{padding:.45rem 1rem;font-size:.8rem}
.link-btn{background:none;border:none;color:var(--primary);font-size:.8rem;font-weight:500}
.link-btn:hover{text-decoration:underline}
.divider{display:flex;align-items:center;gap:.8rem;margin:1rem 0;color:var(--muted);font-size:.75rem;text-transform:uppercase}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border)}
.text-muted{color:var(--muted);font-size:.82rem;text-align:center;margin-top:1rem}

/* Layout */
.app{display:flex;min-height:100vh}
.sidebar{width:240px;background:#1a2a3a;color:#c8d6e5;display:flex;flex-direction:column;padding:1rem 0;position:fixed;top:0;left:0;bottom:0;z-index:50;transition:transform .3s}
.sidebar .logo{display:flex;align-items:center;gap:.6rem;padding:0 1.2rem;margin-bottom:1.5rem}
.sidebar .logo-icon{width:36px;height:36px;border-radius:10px;background:var(--primary);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:1rem}
.sidebar .logo span{font-weight:700;font-size:1.1rem;color:#fff}
.sidebar nav{flex:1}
.sidebar nav a,.sidebar nav button{display:flex;align-items:center;gap:.7rem;padding:.6rem 1.2rem;color:#a0b4c8;font-size:.85rem;font-weight:500;border:none;background:none;width:100%;text-align:left;border-radius:0;transition:all .15s}
.sidebar nav a:hover,.sidebar nav button:hover{background:rgba(255,255,255,.06);color:#fff}
.sidebar nav a.active{background:rgba(13,148,136,.15);color:#5eead4;border-right:3px solid var(--primary)}
.sidebar .user-area{padding:.8rem 1.2rem;border-top:1px solid rgba(255,255,255,.08);font-size:.8rem;color:#7a8fa0}
.main{flex:1;margin-left:240px;padding:1.5rem 2rem;max-width:960px}
.main h1{font-size:1.6rem;font-weight:800;margin-bottom:.3rem}
.main .page-desc{color:var(--muted);font-size:.9rem;margin-bottom:1.5rem}

/* Cards & Stats */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.8rem;margin-bottom:1.5rem}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1rem;display:flex;align-items:center;gap:.8rem;box-shadow:var(--shadow)}
.stat-icon{width:40px;height:40px;border-radius:10px;background:var(--secondary);display:flex;align-items:center;justify-content:center;color:var(--primary);font-size:1.1rem}
.stat-card .val{font-size:1.4rem;font-weight:800}
.stat-card .lbl{font-size:.72rem;color:var(--muted)}
.quick-actions{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:.6rem;margin-bottom:2rem}
.qa-btn{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem .8rem;text-align:center;font-size:.8rem;font-weight:600;color:var(--fg);transition:all .15s;box-shadow:var(--shadow)}
.qa-btn:hover{border-color:var(--primary);background:var(--secondary)}
.qa-btn .icon{font-size:1.4rem;margin-bottom:.3rem}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem;box-shadow:var(--shadow);margin-bottom:.8rem}
.card h3{font-size:.95rem;font-weight:700;margin-bottom:.6rem}

/* Forms */
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:.8rem}
@media(max-width:600px){.form-row{grid-template-columns:1fr}}
.form-group select{width:100%;padding:.6rem .8rem;border:1px solid var(--border);border-radius:8px;outline:none;background:#fff}
.form-group select:focus{border-color:var(--primary)}
.form-group textarea{width:100%;padding:.6rem .8rem;border:1px solid var(--border);border-radius:8px;outline:none;resize:vertical;min-height:80px}
.form-group textarea:focus{border-color:var(--primary)}
.file-drop{border:2px dashed var(--border);border-radius:var(--radius);padding:1.5rem;text-align:center;color:var(--muted);font-size:.85rem;cursor:pointer;transition:border .2s;margin-top:.5rem}
.file-drop:hover{border-color:var(--primary)}
.file-drop input{display:none}

/* CNEB info panel */
.cneb-panel{background:linear-gradient(135deg,#f0fdf9,#e6f5f3);border:1px solid #a7f3d0;border-radius:var(--radius);padding:1rem;margin-bottom:1rem;font-size:.82rem}
.cneb-panel .cneb-title{font-weight:700;color:var(--primary);margin-bottom:.4rem;font-size:.85rem}
.cneb-tag{display:inline-block;background:var(--primary);color:#fff;border-radius:20px;padding:.15rem .6rem;font-size:.72rem;font-weight:600;margin:.15rem .1rem;cursor:pointer;transition:opacity .15s}
.cneb-tag:hover{opacity:.8}

/* Output - rendered HTML */
.output-rendered{background:#fff;border:1px solid #a7f3d0;border-radius:var(--radius);padding:1.5rem 2rem;margin-top:1rem;font-size:.9rem;line-height:1.8;max-height:600px;overflow-y:auto}
.output-rendered h2{color:var(--primary);font-size:1rem;font-weight:700;border-bottom:2px solid var(--secondary);padding-bottom:.3rem;margin:1.2rem 0 .5rem}
.output-rendered h3{color:var(--fg);font-size:.9rem;font-weight:700;margin:.8rem 0 .3rem}
.output-rendered table{width:100%;border-collapse:collapse;font-size:.82rem;margin:.5rem 0}
.output-rendered th{background:var(--primary);color:#fff;padding:.5rem .7rem;text-align:left;font-weight:600}
.output-rendered td{border:1px solid var(--border);padding:.5rem .7rem;vertical-align:top}
.output-rendered tr:nth-child(even) td{background:#f8fffe}
.output-rendered .header-doc{background:linear-gradient(135deg,#0d9488,#0a7a70);color:#fff;border-radius:8px;padding:1.2rem 1.5rem;margin-bottom:1rem;text-align:center}
.output-rendered .header-doc h1{font-size:1.1rem;font-weight:800;margin-bottom:.2rem;color:#fff}
.output-rendered .header-doc p{font-size:.8rem;opacity:.9;margin:0}
.output-rendered .section-box{background:#f8fffe;border-left:3px solid var(--primary);padding:.7rem 1rem;margin:.5rem 0;border-radius:0 8px 8px 0}
.output-rendered .moment-inicio{background:#fff7ed;border-left:3px solid #f97316}
.output-rendered .moment-desarrollo{background:#f0fdf9;border-left:3px solid var(--primary)}
.output-rendered .moment-cierre{background:#fdf4ff;border-left:3px solid #a855f7}
.output-rendered ul{padding-left:1.2rem;margin:.3rem 0}
.output-rendered li{margin:.2rem 0}
.output-rendered .badge-nivel{display:inline-block;padding:.1rem .5rem;border-radius:4px;font-size:.72rem;font-weight:700;background:#d1fae5;color:#065f46}
.output-rendered .tip-box{background:#fef9c3;border:1px solid #fde047;border-radius:8px;padding:.7rem 1rem;font-size:.82rem;margin:.5rem 0}
.output-rendered .tip-box::before{content:'üí° Sugerencia docente: ';font-weight:700}

/* Loading animation */
.loading{display:inline-block;width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.gen-loading{display:flex;align-items:center;gap:.8rem;padding:1.5rem;background:var(--secondary);border-radius:var(--radius);font-size:.9rem;color:var(--sec-fg);font-weight:600;margin-top:1rem}

/* Tabs */
.tabs{display:flex;gap:.3rem;border-bottom:2px solid var(--border);margin-bottom:1.2rem}
.tab{padding:.5rem 1rem;font-size:.85rem;font-weight:600;border:none;background:none;color:var(--muted);border-bottom:2px solid transparent;margin-bottom:-2px;cursor:pointer}
.tab.active{color:var(--primary);border-bottom-color:var(--primary)}
.badge{display:inline-block;padding:.15rem .6rem;border-radius:20px;font-size:.7rem;font-weight:600;background:var(--secondary);color:var(--sec-fg)}

/* Mobile */
.menu-toggle{display:none;position:fixed;top:.8rem;left:.8rem;z-index:60;background:var(--primary);color:#fff;border:none;border-radius:8px;width:40px;height:40px;font-size:1.2rem}
@media(max-width:768px){
  .sidebar{transform:translateX(-100%)}
  .sidebar.open{transform:translateX(0)}
  .main{margin-left:0;padding:1rem}
  .menu-toggle{display:flex;align-items:center;justify-content:center}
}
.hidden{display:none!important}

/* Chat */
.chat-msg{display:flex;gap:.5rem;align-items:flex-start}
.chat-msg.user{flex-direction:row-reverse}
.chat-avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0}
.chat-msg.ai .chat-avatar{background:var(--primary);color:#fff}
.chat-msg.user .chat-avatar{background:var(--accent);color:#fff}
.chat-bubble{max-width:80%;padding:.6rem 1rem;border-radius:16px;font-size:.85rem;line-height:1.6}
.ai-bubble{background:var(--secondary);color:var(--fg);border-bottom-left-radius:4px}
.user-bubble{background:var(--primary);color:#fff;border-bottom-right-radius:4px}
.sug-btn{padding:.35rem .8rem;border-radius:20px;border:1px solid var(--border);background:var(--secondary);color:var(--sec-fg);font-size:.75rem;font-weight:500;cursor:pointer;transition:all .15s}
.sug-btn:hover{background:var(--primary);color:#fff;border-color:var(--primary)}

/* API Key modal */
.apikey-modal{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:200;display:flex;align-items:center;justify-content:center;padding:1rem}
.apikey-box{background:#fff;border-radius:16px;max-width:460px;width:100%;padding:2rem;box-shadow:0 20px 60px rgba(0,0,0,.2)}
.apikey-box h2{font-size:1.15rem;font-weight:800;margin-bottom:.4rem}
.apikey-box p{font-size:.84rem;color:var(--muted);margin-bottom:1.2rem;line-height:1.5}
.apikey-steps{background:#f8fffe;border:1px solid #a7f3d0;border-radius:8px;padding:.8rem 1rem;margin-bottom:1.2rem;font-size:.81rem;line-height:1.8}
.apikey-steps a{color:var(--primary);font-weight:600}
.apikey-input-wrap{position:relative}
.apikey-input-wrap input{width:100%;padding:.65rem 2.8rem .65rem .8rem;border:1.5px solid var(--border);border-radius:8px;font-size:.9rem;outline:none;transition:border .2s;font-family:monospace}
.apikey-input-wrap input:focus{border-color:var(--primary)}
.apikey-eye{position:absolute;right:.7rem;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--muted);font-size:1rem}
.apikey-badge{display:inline-flex;align-items:center;gap:.35rem;background:#fef3c7;border:1px solid #fcd34d;border-radius:6px;padding:.25rem .6rem;font-size:.75rem;font-weight:600;color:#92400e;cursor:pointer;transition:background .15s}
.apikey-badge:hover{background:#fde68a}
.apikey-badge.connected{background:#d1fae5;border-color:#6ee7b7;color:#065f46}

</style>
</head>
<body>

<!-- ====== AUTH ====== -->
<div id="authPage" class="auth-page">
  <div class="auth-box">
    <div class="auth-logo">N</div>
    <h1>Neurosim</h1>
    <p class="subtitle">Planificador de Clases ‚Äì CNEB</p>
    <p class="desc">Genera sesiones, unidades did√°cticas y planificaci√≥n anual alineadas al Curr√≠culo Nacional de Educaci√≥n B√°sica para secundaria.</p>
    <div class="auth-card">
      <h2>üîê Iniciar sesi√≥n</h2>
      <form id="loginForm">
        <div class="form-group">
          <label>Correo electr√≥nico</label>
          <input type="email" id="loginEmail" placeholder="correo@ejemplo.com" required>
        </div>
        <div class="form-group">
          <label>Contrase√±a</label>
          <input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
        </div>
        <button type="submit" class="btn btn-primary" style="margin-top:.5rem">Entrar ‚Üí</button>
      </form>
      <div class="divider">o</div>
      <button class="btn btn-outline" onclick="enterApp()">Acceder como invitado</button>
      <p class="text-muted" style="margin-top:.8rem">¬øNo tienes cuenta? <button class="link-btn" onclick="enterApp()">Reg√≠strate gratis</button></p>
    </div>
  </div>
</div>

<!-- ====== APP ====== -->
<div id="appShell" class="app hidden">
  <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>

  <aside class="sidebar" id="sidebar">
    <div class="logo"><div class="logo-icon">N</div><span>Neurosim</span></div>
    <nav>
      <a href="#" id="nav-dashboard" class="active" onclick="showPage('dashboard',this)">üìä Dashboard</a>
      <a href="#" id="nav-sesion" onclick="showPage('sesion',this)">üìù Sesi√≥n de Aprendizaje</a>
      <a href="#" id="nav-unidad" onclick="showPage('unidad',this)">üìö Unidad Did√°ctica</a>
      <a href="#" id="nav-planificacion" onclick="showPage('planificacion',this)">üìÖ Planificaci√≥n Anual</a>
      <a href="#" id="nav-documentos" onclick="showPage('documentos',this)">üìÅ Mis Documentos</a>
      <a href="#" id="nav-asistente" onclick="showPage('asistente',this)">ü§ñ Asistente IA</a>
      <button onclick="logout()" style="margin-top:auto;color:#f87171">üö™ Cerrar sesi√≥n</button>
    </nav>
    <div class="user-area" style="display:flex;flex-direction:column;gap:.5rem">
      <div>üë§ <span id="userName">Docente</span></div>
      <button class="apikey-badge" id="apikeyBadge" onclick="openApiKeyModal()">
        üîë <span id="apikeyStatus">Conectar API Key</span>
      </button>
    </div>
  </aside>

  <div class="main">
    <!-- DASHBOARD -->
    <div id="page-dashboard">
      <h1>¬°Bienvenido, <span id="welcomeName">Docente</span>! üëã</h1>
      <p class="page-desc">Panel de planificaci√≥n pedag√≥gica ‚Äì CNEB Secundaria</p>
      <div class="stats">
        <div class="stat-card"><div class="stat-icon">üìÑ</div><div><div class="val" id="statDocs">0</div><div class="lbl">Documentos</div></div></div>
        <div class="stat-card"><div class="stat-icon">üìù</div><div><div class="val" id="statSes">0</div><div class="lbl">Sesiones</div></div></div>
        <div class="stat-card"><div class="stat-icon">üìö</div><div><div class="val" id="statUni">0</div><div class="lbl">Unidades</div></div></div>
        <div class="stat-card"><div class="stat-icon">üìÖ</div><div><div class="val" id="statPlan">0</div><div class="lbl">Planificaciones</div></div></div>
      </div>
      <h2 style="font-size:1rem;font-weight:700;margin-bottom:.6rem">Acciones r√°pidas</h2>
      <div class="quick-actions">
        <button class="qa-btn" onclick="showPage('sesion',document.getElementById('nav-sesion'))"><div class="icon">üìù</div>Nueva Sesi√≥n</button>
        <button class="qa-btn" onclick="showPage('unidad',document.getElementById('nav-unidad'))"><div class="icon">üìö</div>Nueva Unidad</button>
        <button class="qa-btn" onclick="showPage('planificacion',document.getElementById('nav-planificacion'))"><div class="icon">üìÖ</div>Plan Anual</button>
        <button class="qa-btn" onclick="showPage('documentos',document.getElementById('nav-documentos'))"><div class="icon">üìÅ</div>Mis Docs</button>
      </div>
      <h2 style="font-size:1rem;font-weight:700;margin-bottom:.6rem">√öltimos generados</h2>
      <div id="recentList"><p style="color:var(--muted);font-size:.85rem">A√∫n no has generado documentos.</p></div>
    </div>

    <!-- SESI√ìN DE APRENDIZAJE -->
    <div id="page-sesion" class="hidden">
      <h1>üìù Sesi√≥n de Aprendizaje</h1>
      <p class="page-desc">Genera una sesi√≥n alineada al CNEB ‚Äì Nivel Secundaria con IA</p>
      <div class="card">
        <h3>Datos de la sesi√≥n</h3>
        <div class="form-row">
          <div class="form-group">
            <label>√Årea Curricular</label>
            <select id="sesArea" onchange="onAreaChange('ses')">
              <option>Comunicaci√≥n</option><option>Matem√°tica</option><option>Ciencia y Tecnolog√≠a</option>
              <option>Ciencias Sociales</option><option>Desarrollo Personal, Ciudadan√≠a y C√≠vica</option>
              <option>Educaci√≥n F√≠sica</option><option>Arte y Cultura</option>
              <option>Educaci√≥n Religiosa</option><option>Ingl√©s como Lengua Extranjera</option>
              <option>Educaci√≥n para el Trabajo</option>
            </select>
          </div>
          <div class="form-group">
            <label>Grado</label>
            <select id="sesGrado" onchange="onAreaChange('ses')">
              <option>1¬∞ Secundaria</option><option>2¬∞ Secundaria</option><option>3¬∞ Secundaria</option>
              <option>4¬∞ Secundaria</option><option>5¬∞ Secundaria</option>
            </select>
          </div>
        </div>

        <!-- Panel CNEB auto -->
        <div id="sesCnebPanel" class="cneb-panel">
          <div class="cneb-title">üìã Competencias CNEB del √°rea (haz clic para seleccionar)</div>
          <div id="sesCnebCompetencias"></div>
        </div>

        <div class="form-group"><label>T√≠tulo de la sesi√≥n</label><input id="sesTitulo" placeholder="Ej: Analizamos textos argumentativos sobre el cambio clim√°tico"></div>
        <div class="form-group">
          <label>Competencia seleccionada</label>
          <select id="sesCompetencia" onchange="onCompetenciaChange('ses')">
            <option value="">-- Selecciona una competencia --</option>
          </select>
        </div>
        <div class="form-group">
          <label>Capacidades</label>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.3rem"><span style="font-size:.75rem;color:var(--muted)">Marca las capacidades que trabajar√°s en esta sesi√≥n:</span><button type="button" onclick="toggleAllCaps('ses')" style="font-size:.72rem;background:none;border:1px solid var(--border);border-radius:4px;padding:.1rem .4rem;color:var(--sec-fg)">Seleccionar/Deseleccionar todas</button></div>
          <div id="sesCapacidades" style="background:#f8fffe;border:1px solid var(--border);border-radius:8px;padding:.6rem .8rem;font-size:.85rem;color:var(--muted);min-height:40px">Selecciona un √°rea y competencia primero</div>
        </div>
        <div class="form-group">
          <label>Desempe√±o precisado</label>
          <textarea id="sesDesempeno" placeholder="Describe el desempe√±o que se espera lograr o edita el sugerido..." style="min-height:60px"></textarea>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Duraci√≥n (minutos)</label><input type="number" id="sesDuracion" value="90" min="45" max="180"></div>
          <div class="form-group"><label>N√∫mero de estudiantes</label><input type="number" id="sesEstudiantes" value="30" min="5" max="50"></div>
        </div>
        <div class="form-group"><label>Enfoque transversal</label>
          <select id="sesEnfoque">
            <option>Enfoque de derechos</option><option>Enfoque inclusivo o de atenci√≥n a la diversidad</option>
            <option>Enfoque intercultural</option><option>Enfoque de igualdad de g√©nero</option>
            <option>Enfoque ambiental</option><option>Enfoque de orientaci√≥n al bien com√∫n</option>
            <option>Enfoque de b√∫squeda de la excelencia</option>
          </select>
        </div>
        <div class="form-group"><label>Contexto o situaci√≥n significativa (opcional)</label>
          <textarea id="sesContexto" placeholder="Describe el contexto local, problema o situaci√≥n del entorno..." style="min-height:60px"></textarea>
        </div>
        <div class="file-drop" id="sesFileDrop" onclick="this.querySelector('input').click()">
          üìé Subir archivo de referencia (PDF, Word, imagen)<br><small>Arrastra o haz clic aqu√≠</small>
          <input type="file" id="sesFile" accept=".pdf,.doc,.docx,.jpg,.png" onchange="showFileName('sesFileDrop',this)">
        </div>
        <div style="margin-top:1rem;display:flex;gap:.5rem;align-items:center">
          <button class="btn btn-primary" id="btnGenSes" onclick="generarSesionIA()" style="width:auto">‚ú® Generar Sesi√≥n con IA</button>
          <span style="font-size:.78rem;color:var(--muted)">Genera una gu√≠a pedag√≥gica completa</span>
        </div>
      </div>
      <div id="sesOutput"></div>
    </div>

    <!-- UNIDAD DID√ÅCTICA -->
    <div id="page-unidad" class="hidden">
      <h1>üìö Unidad Did√°ctica</h1>
      <p class="page-desc">Genera una unidad did√°ctica completa con IA ‚Äì CNEB Secundaria</p>
      <div class="card">
        <h3>Datos de la unidad</h3>
        <div class="form-row">
          <div class="form-group">
            <label>√Årea Curricular</label>
            <select id="uniArea" onchange="onAreaChange('uni')">
              <option>Comunicaci√≥n</option><option>Matem√°tica</option><option>Ciencia y Tecnolog√≠a</option>
              <option>Ciencias Sociales</option><option>Desarrollo Personal, Ciudadan√≠a y C√≠vica</option>
              <option>Educaci√≥n F√≠sica</option><option>Arte y Cultura</option>
              <option>Educaci√≥n Religiosa</option><option>Ingl√©s como Lengua Extranjera</option>
              <option>Educaci√≥n para el Trabajo</option>
            </select>
          </div>
          <div class="form-group">
            <label>Grado</label>
            <select id="uniGrado" onchange="onAreaChange('uni')">
              <option>1¬∞ Secundaria</option><option>2¬∞ Secundaria</option><option>3¬∞ Secundaria</option>
              <option>4¬∞ Secundaria</option><option>5¬∞ Secundaria</option>
            </select>
          </div>
        </div>

        <div id="uniCnebPanel" class="cneb-panel">
          <div class="cneb-title">üìã Competencias CNEB del √°rea (haz clic para agregar)</div>
          <div id="uniCnebCompetencias"></div>
        </div>

        <div class="form-group"><label>T√≠tulo de la Unidad</label><input id="uniTitulo" placeholder="Ej: Comprendemos y producimos textos argumentativos"></div>
        <div class="form-row">
          <div class="form-group"><label>N√∫mero de Unidad</label><input type="number" id="uniNumero" value="1" min="1" max="10"></div>
          <div class="form-group"><label>N√∫mero de sesiones</label><input type="number" id="uniSesiones" value="6" min="1" max="20"></div>
        </div>
        <div class="form-group"><label>Competencias a trabajar</label>
          <textarea id="uniCompetencias" placeholder="Se llenar√° al hacer clic en las competencias de arriba, o escr√≠belas manualmente..." style="min-height:70px"></textarea>
        </div>
        <div class="form-group"><label>Situaci√≥n significativa</label>
          <textarea id="uniSituacion" placeholder="Describe la situaci√≥n significativa del contexto local/regional..." style="min-height:80px"></textarea>
        </div>
        <div class="form-group"><label>Enfoques transversales</label>
          <input id="uniEnfoques" placeholder="Ej: Enfoque intercultural, Enfoque de derechos" value="Enfoque de derechos, Enfoque intercultural">
        </div>
        <div class="file-drop" id="uniFileDrop" onclick="this.querySelector('input').click()">
          üìé Subir ejemplo o referencia (PDF, Word)<br><small>Se usar√° como base para la generaci√≥n</small>
          <input type="file" id="uniFile" accept=".pdf,.doc,.docx" onchange="showFileName('uniFileDrop',this)">
        </div>
        <div style="margin-top:1rem"><button class="btn btn-primary" id="btnGenUni" onclick="generarUnidadIA()" style="width:auto">‚ú® Generar Unidad con IA</button></div>
      </div>
      <div id="uniOutput"></div>
    </div>

    <!-- PLANIFICACI√ìN ANUAL -->
    <div id="page-planificacion" class="hidden">
      <h1>üìÖ Planificaci√≥n Curricular Anual</h1>
      <p class="page-desc">Genera la planificaci√≥n anual alineada al CNEB con IA ‚Äì Secundaria</p>
      <div class="card">
        <h3>Datos generales</h3>
        <div class="form-row">
          <div class="form-group">
            <label>√Årea Curricular</label>
            <select id="planArea" onchange="onAreaChange('plan')">
              <option>Comunicaci√≥n</option><option>Matem√°tica</option><option>Ciencia y Tecnolog√≠a</option>
              <option>Ciencias Sociales</option><option>Desarrollo Personal, Ciudadan√≠a y C√≠vica</option>
              <option>Educaci√≥n F√≠sica</option><option>Arte y Cultura</option>
              <option>Educaci√≥n Religiosa</option><option>Ingl√©s como Lengua Extranjera</option>
              <option>Educaci√≥n para el Trabajo</option>
            </select>
          </div>
          <div class="form-group">
            <label>Grado</label>
            <select id="planGrado" onchange="onAreaChange('plan')">
              <option>1¬∞ Secundaria</option><option>2¬∞ Secundaria</option><option>3¬∞ Secundaria</option>
              <option>4¬∞ Secundaria</option><option>5¬∞ Secundaria</option>
            </select>
          </div>
        </div>

        <div id="planCnebPanel" class="cneb-panel">
          <div class="cneb-title">üìã Competencias CNEB del √°rea (haz clic para agregar)</div>
          <div id="planCnebCompetencias"></div>
        </div>

        <div class="form-row">
          <div class="form-group"><label>A√±o Lectivo</label><input type="number" id="planAnio" value="2026"></div>
          <div class="form-group"><label>N√∫mero de Unidades</label><input type="number" id="planUnidades" value="8" min="4" max="12"></div>
        </div>
        <div class="form-group"><label>I.E. (Instituci√≥n Educativa)</label><input id="planIE" placeholder="Nombre de la Instituci√≥n Educativa"></div>
        <div class="form-group"><label>Competencias del √°rea</label>
          <textarea id="planCompetencias" placeholder="Se llenar√° autom√°ticamente al seleccionar el √°rea..." style="min-height:70px"></textarea>
        </div>
        <div class="form-group"><label>Descripci√≥n general del √°rea</label>
          <textarea id="planDesc" placeholder="Breve descripci√≥n del enfoque del √°rea para este grado..."></textarea>
        </div>
        <div class="file-drop" id="planFileDrop" onclick="this.querySelector('input').click()">
          üìé Subir planificaci√≥n anterior o ejemplo<br><small>PDF o Word</small>
          <input type="file" id="planFile" accept=".pdf,.doc,.docx" onchange="showFileName('planFileDrop',this)">
        </div>
        <div style="margin-top:1rem"><button class="btn btn-primary" id="btnGenPlan" onclick="generarPlanAnualIA()" style="width:auto">‚ú® Generar Planificaci√≥n con IA</button></div>
      </div>
      <div id="planOutput"></div>
    </div>

    <!-- ASISTENTE IA -->
    <div id="page-asistente" class="hidden">
      <h1>ü§ñ Asistente Pedag√≥gico IA</h1>
      <p class="page-desc">Resuelve dudas did√°cticas, metodol√≥gicas y de planificaci√≥n CNEB</p>
      <div class="card" style="display:flex;flex-direction:column;height:calc(100vh - 12rem);padding:0;overflow:hidden">
        <div id="chatMessages" style="flex:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:.6rem">
          <div class="chat-msg ai"><div class="chat-avatar">ü§ñ</div><div class="chat-bubble ai-bubble">¬°Hola! Soy tu asistente pedag√≥gico IA. Puedo ayudarte con:<br>‚Ä¢ Dudas sobre el CNEB y competencias<br>‚Ä¢ Metodolog√≠as activas para secundaria<br>‚Ä¢ Redacci√≥n pedag√≥gica formal<br>‚Ä¢ Instrumentos de evaluaci√≥n<br>‚Ä¢ Adaptaci√≥n de sesiones para ritmos diferentes<br><br>¬øEn qu√© te ayudo hoy?</div></div>
        </div>
        <div id="chatSuggestions" style="padding:.5rem 1rem;display:flex;flex-wrap:wrap;gap:.4rem;border-top:1px solid var(--border)">
          <button class="sug-btn" onclick="useSuggestion(this)">¬øC√≥mo adaptar una sesi√≥n para estudiantes con ritmos diferentes?</button>
          <button class="sug-btn" onclick="useSuggestion(this)">Sugiere metodolog√≠as activas para Ciencia y Tecnolog√≠a</button>
          <button class="sug-btn" onclick="useSuggestion(this)">¬øQu√© instrumentos de evaluaci√≥n usar para competencias?</button>
          <button class="sug-btn" onclick="useSuggestion(this)">Convierte este texto a redacci√≥n pedag√≥gica formal</button>
        </div>
        <div style="padding:.8rem 1rem;border-top:1px solid var(--border);display:flex;gap:.5rem">
          <input id="chatInput" placeholder="Escribe tu pregunta pedag√≥gica..." style="flex:1;padding:.6rem .8rem;border:1px solid var(--border);border-radius:8px;outline:none" onkeydown="if(event.key==='Enter')sendChat()">
          <button class="btn btn-primary" onclick="sendChat()" style="width:auto;padding:.6rem 1rem">üì§ Enviar</button>
        </div>
      </div>
    </div>

    <!-- MIS DOCUMENTOS -->
    <div id="page-documentos" class="hidden">
      <h1>üìÅ Mis Documentos</h1>
      <p class="page-desc">Documentos generados y guardados</p>
      <div class="tabs">
        <button class="tab active" id="tab-all" onclick="filterDocs('all',this)">Todos</button>
        <button class="tab" id="tab-sesion" onclick="filterDocs('sesion',this)">Sesiones</button>
        <button class="tab" id="tab-unidad" onclick="filterDocs('unidad',this)">Unidades</button>
        <button class="tab" id="tab-plan" onclick="filterDocs('plan',this)">Planificaciones</button>
      </div>
      <div id="docsList"></div>
    </div>
  </div>
</div>

<!-- API KEY MODAL -->
<div id="apikeyModal" class="apikey-modal hidden">
  <div class="apikey-box">
    <h2>üîë Conectar con la IA de Anthropic</h2>
    <p>Para generar documentos con Inteligencia Artificial necesitas una API Key de Anthropic. Se guarda <strong>solo en tu navegador</strong> y nunca se comparte.</p>
    <div class="apikey-steps">
      <strong>C√≥mo obtener tu API Key gratis:</strong><br>
      1. Ve a <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a><br>
      2. Crea una cuenta gratuita (incluye cr√©ditos iniciales)<br>
      3. En el men√∫: <strong>API Keys ‚Üí Create Key</strong><br>
      4. Copia la key (empieza con <code>sk-ant-</code>) y p√©gala aqu√≠
    </div>
    <div class="form-group" style="margin-bottom:.8rem">
      <label>Tu API Key de Anthropic</label>
      <div class="apikey-input-wrap">
        <input type="password" id="apikeyInput" placeholder="sk-ant-api03-..." autocomplete="off" spellcheck="false">
        <button class="apikey-eye" onclick="toggleApiKeyVisibility()" id="eyeBtn">üëÅ</button>
      </div>
    </div>
    <div style="display:flex;gap:.5rem;margin-top:.2rem">
      <button class="btn btn-primary" onclick="saveApiKey()" style="width:auto;flex:1">‚úÖ Guardar y conectar</button>
      <button class="btn btn-outline" onclick="closeApiKeyModal()" style="width:auto">Cancelar</button>
    </div>
    <p style="font-size:.75rem;color:var(--muted);margin-top:.8rem;text-align:center">üîí La key se guarda en localStorage de tu navegador. Nunca se env√≠a a ning√∫n servidor excepto api.anthropic.com</p>
  </div>
</div>

<script>
// =============================================
// CNEB DATA ‚Äì MINEDU PER√ö (Secundaria)
// =============================================
const CNEB = {
  'Comunicaci√≥n': {
    competencias: [
      {
        nombre: 'Se comunica oralmente en su lengua materna',
        capacidades: ['Obtiene informaci√≥n del texto oral','Infiere e interpreta informaci√≥n del texto oral','Adec√∫a, organiza y desarrolla las ideas de forma coherente y cohesionada','Utiliza recursos no verbales y paraverbales de forma estrat√©gica','Interact√∫a estrat√©gicamente con distintos interlocutores','Reflexiona y eval√∫a la forma, el contenido y contexto del texto oral'],
        desempenos: {
          '1¬∞ Secundaria': 'Expresa oralmente ideas y emociones en torno a un tema de forma coherente y clara, usando un vocabulario pertinente, y reflexiona sobre lo que dijo.',
          '2¬∞ Secundaria': 'Expresa oralmente ideas organizadas y registros apropiados al interlocutor, haciendo uso de recursos no verbales.',
          '3¬∞ Secundaria': 'Expresa y defiende puntos de vista, contraargumenta ideas y eval√∫a la coherencia del texto oral seg√∫n el prop√≥sito.',
          '4¬∞ Secundaria': 'Participa en debates y exposiciones fundamentando sus posiciones con argumentos s√≥lidos y fuentes confiables.',
          '5¬∞ Secundaria': 'Produce textos orales complejos con argumentaci√≥n acad√©mica, adaptando el registro y valorando la influencia del contexto sociocultural.'
        }
      },
      {
        nombre: 'Lee diversos tipos de textos escritos en su lengua materna',
        capacidades: ['Obtiene informaci√≥n del texto escrito','Infiere e interpreta informaci√≥n del texto','Reflexiona y eval√∫a la forma, el contenido y contexto del texto'],
        desempenos: {
          '1¬∞ Secundaria': 'Identifica informaci√≥n expl√≠cita e impl√≠cita en textos de estructura simple y deduce relaciones de causa-efecto.',
          '2¬∞ Secundaria': 'Distingue informaci√≥n relevante, deduciendo relaciones impl√≠citas y reflexionando sobre el uso de recursos textuales.',
          '3¬∞ Secundaria': 'Interpreta textos comparando informaci√≥n, reconociendo el punto de vista del autor y evaluando su estructura argumentativa.',
          '4¬∞ Secundaria': 'Eval√∫a cr√≠ticamente textos con m√∫ltiples perspectivas, reconociendo intenciones del autor y efectos en el lector.',
          '5¬∞ Secundaria': 'Lee textos complejos, interpreta met√°foras y figuras, y eval√∫a el impacto ideol√≥gico, social y cultural del texto.'
        }
      },
      {
        nombre: 'Escribe diversos tipos de textos en su lengua materna',
        capacidades: ['Adec√∫a el texto a la situaci√≥n comunicativa','Organiza y desarrolla las ideas de forma coherente y cohesionada','Utiliza convenciones del lenguaje escrito de forma pertinente','Reflexiona y eval√∫a la forma, el contenido y contexto del texto escrito'],
        desempenos: {
          '1¬∞ Secundaria': 'Escribe textos de forma coherente, considerando el prop√≥sito, destinatario y tipo textual, revisando y mejorando su producci√≥n.',
          '2¬∞ Secundaria': 'Produce textos variados con ideas desarrolladas, uso adecuado de conectores y normativa ortogr√°fica.',
          '3¬∞ Secundaria': 'Escribe textos argumentativos y expositivos con estructura clara, fuentes y revisi√≥n cr√≠tica del proceso de escritura.',
          '4¬∞ Secundaria': 'Produce ensayos y art√≠culos de opini√≥n con posici√≥n sustentada, vocabulario acad√©mico y recursos ret√≥ricos pertinentes.',
          '5¬∞ Secundaria': 'Escribe textos formales complejos con intenci√≥n est√©tica o acad√©mica, evaluando el impacto comunicativo de sus decisiones.'
        }
      }
    ]
  },
  'Matem√°tica': {
    competencias: [
      {
        nombre: 'Resuelve problemas de cantidad',
        capacidades: ['Traduce cantidades a expresiones num√©ricas','Comunica su comprensi√≥n sobre los n√∫meros y las operaciones','Usa estrategias y procedimientos de estimaci√≥n y c√°lculo','Argumenta afirmaciones sobre las relaciones num√©ricas y las operaciones'],
        desempenos: {
          '1¬∞ Secundaria': 'Establece relaciones entre datos y los transforma en expresiones num√©ricas (fracciones, decimales, potencias) para resolver problemas.',
          '2¬∞ Secundaria': 'Opera con n√∫meros racionales e irracionales en situaciones contextualizadas, seleccionando estrategias eficientes.',
          '3¬∞ Secundaria': 'Aplica operaciones con n√∫meros reales y proporcionalidad para resolver problemas de diversa complejidad.',
          '4¬∞ Secundaria': 'Resuelve problemas usando progresiones, logaritmos y combinatoria, argumentando sus procedimientos.',
          '5¬∞ Secundaria': 'Resuelve problemas complejos que involucran n√∫meros complejos y matrices, justificando sus estrategias matem√°ticas.'
        }
      },
      {
        nombre: 'Resuelve problemas de regularidad, equivalencia y cambio',
        capacidades: ['Traduce datos y condiciones a expresiones algebraicas','Comunica su comprensi√≥n sobre las relaciones algebraicas','Usa estrategias y procedimientos para encontrar reglas generales','Argumenta afirmaciones sobre relaciones de cambio y equivalencia'],
        desempenos: {
          '1¬∞ Secundaria': 'Traduce datos de problemas a expresiones algebraicas (ecuaciones, inecuaciones lineales) y las resuelve justificando el proceso.',
          '2¬∞ Secundaria': 'Modela situaciones con funciones lineales y cuadr√°ticas, interpreta gr√°ficos y eval√∫a la pertinencia del modelo.',
          '3¬∞ Secundaria': 'Establece relaciones entre funciones y sus representaciones, interpretando tasas de cambio en contextos reales.',
          '4¬∞ Secundaria': 'Modela con funciones exponenciales y trigonom√©tricas, argumentando sobre sus propiedades y comportamiento.',
          '5¬∞ Secundaria': 'Resuelve sistemas de ecuaciones y aplica c√°lculo diferencial b√°sico para analizar situaciones de cambio.'
        }
      },
      {
        nombre: 'Resuelve problemas de forma, movimiento y localizaci√≥n',
        capacidades: ['Modela objetos con formas geom√©tricas','Comunica su comprensi√≥n sobre las formas y relaciones geom√©tricas','Usa estrategias y procedimientos para orientarse en el espacio','Argumenta afirmaciones sobre relaciones geom√©tricas'],
        desempenos: {
          '1¬∞ Secundaria': 'Modela figuras planas con propiedades geom√©tricas y calcula per√≠metros y √°reas resolviendo problemas contextualizados.',
          '2¬∞ Secundaria': 'Calcula √°reas y vol√∫menes de cuerpos geom√©tricos aplicando transformaciones y propiedades de semejanza.',
          '3¬∞ Secundaria': 'Aplica trigonometr√≠a para resolver problemas de medici√≥n indirecta, representando en el plano cartesiano.',
          '4¬∞ Secundaria': 'Modela situaciones con vectores y aplica geometr√≠a anal√≠tica para resolver problemas del entorno.',
          '5¬∞ Secundaria': 'Resuelve problemas usando razones trigonom√©tricas avanzadas y geometr√≠a del espacio tridimensional.'
        }
      },
      {
        nombre: 'Resuelve problemas de gesti√≥n de datos e incertidumbre',
        capacidades: ['Representa datos con gr√°ficos y medidas estad√≠sticas','Comunica la comprensi√≥n de los conceptos estad√≠sticos','Usa estrategias y procedimientos para recopilar y procesar datos','Sustenta conclusiones basadas en informaci√≥n estad√≠stica'],
        desempenos: {
          '1¬∞ Secundaria': 'Recopila, organiza y representa datos con tablas y gr√°ficos, calculando medidas de tendencia central e interpretando resultados.',
          '2¬∞ Secundaria': 'Calcula medidas de dispersi√≥n y probabilidad de eventos simples, interpretando en situaciones de incertidumbre.',
          '3¬∞ Secundaria': 'Selecciona y usa t√©cnicas estad√≠sticas para analizar datos, evaluando la pertinencia de las representaciones.',
          '4¬∞ Secundaria': 'Aplica regla de Laplace y probabilidades condicionales, interpretando distribuciones en contextos reales.',
          '5¬∞ Secundaria': 'Dise√±a estudios estad√≠sticos, aplica distribuciones de probabilidad y toma decisiones fundamentadas en datos.'
        }
      }
    ]
  },
  'Ciencia y Tecnolog√≠a': {
    competencias: [
      {
        nombre: 'Indaga mediante m√©todos cient√≠ficos para construir sus conocimientos',
        capacidades: ['Problematiza situaciones','Dise√±a estrategias para hacer indagaci√≥n','Genera y registra datos e informaci√≥n','Analiza datos e informaci√≥n','Eval√∫a y comunica el proceso y resultados de su indagaci√≥n'],
        desempenos: {
          '1¬∞ Secundaria': 'Formula preguntas e hip√≥tesis sobre fen√≥menos naturales, dise√±a y ejecuta indagaciones simples, analiza datos y comunica resultados.',
          '2¬∞ Secundaria': 'Dise√±a indagaciones con variables controladas, selecciona instrumentos de medici√≥n adecuados y comunica conclusiones con evidencias.',
          '3¬∞ Secundaria': 'Realiza indagaciones controladas, analiza datos con estad√≠stica b√°sica y eval√∫a la confiabilidad de los resultados.',
          '4¬∞ Secundaria': 'Dise√±a y ejecuta investigaciones sistem√°ticas, reconoce fuentes de error y elabora informes cient√≠ficos con rigor.',
          '5¬∞ Secundaria': 'Desarrolla proyectos de investigaci√≥n completos, aplica modelos cient√≠ficos y eval√∫a el impacto de sus conclusiones.'
        }
      },
      {
        nombre: 'Explica el mundo f√≠sico bas√°ndose en conocimientos sobre los seres vivos, materia y energ√≠a, biodiversidad, Tierra y universo',
        capacidades: ['Comprende y usa conocimientos sobre los seres vivos','Eval√∫a las implicancias del saber y del quehacer cient√≠fico y tecnol√≥gico'],
        desempenos: {
          '1¬∞ Secundaria': 'Explica las caracter√≠sticas de los seres vivos, la materia y la energ√≠a usando conceptos cient√≠ficos y modelos sencillos.',
          '2¬∞ Secundaria': 'Describe los procesos vitales, estructura de la materia y fen√≥menos f√≠sicos, relacionando causas y efectos.',
          '3¬∞ Secundaria': 'Explica transformaciones de energ√≠a, reacciones qu√≠micas y procesos biol√≥gicos usando modelos cient√≠ficos.',
          '4¬∞ Secundaria': 'Relaciona conceptos de biolog√≠a celular, qu√≠mica org√°nica y f√≠sica con fen√≥menos del entorno, evaluando sus aplicaciones.',
          '5¬∞ Secundaria': 'Explica el funcionamiento de sistemas complejos (gen√©tica, mec√°nica cu√°ntica b√°sica, ecolog√≠a) con argumentaci√≥n cient√≠fica.'
        }
      },
      {
        nombre: 'Dise√±a y construye soluciones tecnol√≥gicas para resolver problemas de su entorno',
        capacidades: ['Determina una alternativa de soluci√≥n tecnol√≥gica','Dise√±a la alternativa de soluci√≥n tecnol√≥gica','Implementa y valida alternativas de soluci√≥n tecnol√≥gica','Eval√∫a y comunica el funcionamiento y los impactos de su alternativa de soluci√≥n'],
        desempenos: {
          '1¬∞ Secundaria': 'Identifica problemas del entorno, dise√±a y construye soluciones tecnol√≥gicas simples, evaluando su funcionalidad.',
          '2¬∞ Secundaria': 'Dise√±a prototipos tecnol√≥gicos con especificaciones t√©cnicas, los construye y eval√∫a considerando factibilidad y seguridad.',
          '3¬∞ Secundaria': 'Desarrolla soluciones tecnol√≥gicas con mayor complejidad, evaluando su impacto ambiental y social.',
          '4¬∞ Secundaria': 'Dise√±a soluciones tecnol√≥gicas innovadoras usando principios cient√≠ficos, evaluando costos y beneficios.',
          '5¬∞ Secundaria': 'Desarrolla proyectos tecnol√≥gicos integrales que responden a problemas reales, con an√°lisis de impacto y sostenibilidad.'
        }
      }
    ]
  },
  'Ciencias Sociales': {
    competencias: [
      {
        nombre: 'Construye interpretaciones hist√≥ricas',
        capacidades: ['Interpreta cr√≠ticamente fuentes diversas','Comprende el tiempo hist√≥rico','Elabora explicaciones sobre procesos hist√≥ricos'],
        desempenos: {
          '1¬∞ Secundaria': 'Explica procesos hist√≥ricos del Per√∫ antiguo y medieval usando fuentes diversas, identificando causas y consecuencias.',
          '2¬∞ Secundaria': 'Interpreta el proceso de formaci√≥n del mundo moderno y colonial, usando fuentes primarias y secundarias.',
          '3¬∞ Secundaria': 'Explica la independencia y formaci√≥n de las rep√∫blicas latinoamericanas comparando perspectivas historiogr√°ficas.',
          '4¬∞ Secundaria': 'Analiza procesos hist√≥ricos del siglo XX en el Per√∫ y el mundo, evaluando su impacto en el presente.',
          '5¬∞ Secundaria': 'Elabora interpretaciones complejas sobre procesos hist√≥ricos recientes, reconociendo m√∫ltiples causalidades y perspectivas.'
        }
      },
      {
        nombre: 'Gestiona responsablemente el espacio y el ambiente',
        capacidades: ['Comprende las relaciones entre los elementos naturales y sociales','Maneja fuentes de informaci√≥n para comprender el espacio geogr√°fico','Genera acciones para preservar el ambiente local y global'],
        desempenos: {
          '1¬∞ Secundaria': 'Explica c√≥mo las caracter√≠sticas geogr√°ficas del Per√∫ influyen en las actividades humanas y en los riesgos ambientales.',
          '2¬∞ Secundaria': 'Analiza problemas ambientales locales y globales, proponiendo acciones de conservaci√≥n del territorio.',
          '3¬∞ Secundaria': 'Eval√∫a el impacto de las actividades econ√≥micas sobre el ambiente y propone alternativas sostenibles.',
          '4¬∞ Secundaria': 'Examina los procesos de globalizaci√≥n y su influencia en el territorio, evaluando sus consecuencias socioambientales.',
          '5¬∞ Secundaria': 'Propone y sustenta soluciones frente a problemas ambientales complejos, considerando el desarrollo sostenible.'
        }
      },
      {
        nombre: 'Gestiona responsablemente los recursos econ√≥micos',
        capacidades: ['Comprende las relaciones entre los elementos del sistema econ√≥mico y financiero','Toma decisiones econ√≥micas y financieras'],
        desempenos: {
          '1¬∞ Secundaria': 'Explica c√≥mo las familias y las empresas toman decisiones econ√≥micas y el rol del Estado en la econom√≠a.',
          '2¬∞ Secundaria': 'Analiza el funcionamiento del mercado, los precios y el impacto de las decisiones de consumo en su entorno.',
          '3¬∞ Secundaria': 'Comprende el sistema financiero peruano y aplica conceptos b√°sicos de ahorro, cr√©dito e inversi√≥n.',
          '4¬∞ Secundaria': 'Eval√∫a el impacto de las pol√≠ticas econ√≥micas nacionales en el bienestar de la poblaci√≥n.',
          '5¬∞ Secundaria': 'Analiza problemas econ√≥micos del Per√∫ en el contexto global y propone alternativas fundamentadas.'
        }
      }
    ]
  },
  'Desarrollo Personal, Ciudadan√≠a y C√≠vica': {
    competencias: [
      {
        nombre: 'Construye su identidad',
        capacidades: ['Se valora a s√≠ mismo','Autorregula sus emociones','Reflexiona y argumenta √©ticamente','Vive su sexualidad de manera plena y responsable'],
        desempenos: {
          '1¬∞ Secundaria': 'Describe sus caracter√≠sticas personales, reconoce sus emociones y establece metas personales con apoyo.',
          '2¬∞ Secundaria': 'Reflexiona sobre su identidad personal y cultural, regula sus emociones y analiza dilemas √©ticos sencillos.',
          '3¬∞ Secundaria': 'Eval√∫a sus valores, maneja el estr√©s y argumenta posiciones √©ticas fundamentadas ante situaciones complejas.',
          '4¬∞ Secundaria': 'Integra su identidad cultural e hist√≥rica, gestiona sus emociones en situaciones de conflicto y debate √©tica aplicada.',
          '5¬∞ Secundaria': 'Construye un proyecto de vida coherente con sus valores y el bienestar colectivo, reflexionando con pensamiento cr√≠tico.'
        }
      },
      {
        nombre: 'Convive y participa democr√°ticamente en la b√∫squeda del bien com√∫n',
        capacidades: ['Interact√∫a con todas las personas','Construye normas y asume acuerdos y leyes','Maneja conflictos de manera constructiva','Delibera sobre asuntos p√∫blicos','Participa en acciones que promueven el bienestar com√∫n'],
        desempenos: {
          '1¬∞ Secundaria': 'Muestra respeto por la diversidad, cumple acuerdos del aula y participa en iniciativas que benefician a su comunidad.',
          '2¬∞ Secundaria': 'Analiza problemas de convivencia, propone normas democr√°ticas y participa en espacios de deliberaci√≥n escolar.',
          '3¬∞ Secundaria': 'Delibera sobre problemas p√∫blicos, ejerce sus derechos ciudadanos y promueve la inclusi√≥n y la equidad.',
          '4¬∞ Secundaria': 'Participa activamente en espacios democr√°ticos, propone soluciones fundamentadas a problemas de su comunidad.',
          '5¬∞ Secundaria': 'Ejerce ciudadan√≠a cr√≠tica, promueve la justicia social y lidera iniciativas de participaci√≥n c√≠vica responsable.'
        }
      }
    ]
  },
  'Educaci√≥n F√≠sica': {
    competencias: [
      {
        nombre: 'Se desenvuelve de manera aut√≥noma a trav√©s de su motricidad',
        capacidades: ['Comprende su cuerpo','Se expresa corporalmente'],
        desempenos: {
          '1¬∞ Secundaria': 'Reconoce los cambios en su cuerpo durante la adolescencia y los asocia con su pr√°ctica motriz y bienestar.',
          '2¬∞ Secundaria': 'Regula su respiraci√≥n y postura en actividades motrices, reconociendo sensaciones corporales y emocionales.',
          '3¬∞ Secundaria': 'Adapta sus posibilidades motrices a diferentes contextos, valorando el cuerpo como fuente de expresi√≥n.',
          '4¬∞ Secundaria': 'Gestiona su actividad f√≠sica con autonom√≠a, reconociendo sus capacidades y limitaciones para el bienestar.',
          '5¬∞ Secundaria': 'Dise√±a y eval√∫a planes de actividad f√≠sica para el bienestar personal, considerando criterios de salud y prevenci√≥n.'
        }
      },
      {
        nombre: 'Asume una vida saludable',
        capacidades: ['Comprende las relaciones entre actividad f√≠sica, alimentaci√≥n, postura e higiene personal','Incorpora pr√°cticas que mejoran su calidad de vida'],
        desempenos: {
          '1¬∞ Secundaria': 'Incorpora h√°bitos de actividad f√≠sica regular e higiene, relacion√°ndolos con su bienestar f√≠sico y emocional.',
          '2¬∞ Secundaria': 'Dise√±a rutinas b√°sicas de actividad f√≠sica y h√°bitos alimenticios saludables adaptados a su contexto.',
          '3¬∞ Secundaria': 'Analiza factores de riesgo en el estilo de vida adolescente y propone acciones preventivas.',
          '4¬∞ Secundaria': 'Eval√∫a cr√≠ticamente los mensajes sobre salud en los medios y dise√±a estrategias para una vida activa y saludable.',
          '5¬∞ Secundaria': 'Promueve una cultura de salud en su comunidad, fundamentando sus propuestas con informaci√≥n cient√≠fica.'
        }
      },
      {
        nombre: 'Interact√∫a a trav√©s de sus habilidades sociomotrices',
        capacidades: ['Se relaciona utilizando sus habilidades sociomotrices','Crea y aplica estrategias y t√°cticas de juego'],
        desempenos: {
          '1¬∞ Secundaria': 'Participa en juegos y deportes respetando reglas, roles y a sus compa√±eros, colaborando para alcanzar metas comunes.',
          '2¬∞ Secundaria': 'Aplica principios t√°cticos en deportes colectivos, valorando la cooperaci√≥n y la inclusi√≥n.',
          '3¬∞ Secundaria': 'Dise√±a y aplica estrategias motrices en situaciones de juego, reflexionando sobre la inclusi√≥n y el trabajo en equipo.',
          '4¬∞ Secundaria': 'Organiza y dirige actividades deportivas, promoviendo el juego limpio y la convivencia pac√≠fica.',
          '5¬∞ Secundaria': 'Lidera proyectos recreativos y deportivos en su comunidad, promoviendo la equidad y el bienestar colectivo.'
        }
      }
    ]
  },
  'Arte y Cultura': {
    competencias: [
      {
        nombre: 'Aprecia de manera cr√≠tica manifestaciones art√≠stico-culturales',
        capacidades: ['Percibe manifestaciones art√≠stico-culturales','Contextualiza manifestaciones culturales','Reflexiona creativa y cr√≠ticamente sobre manifestaciones art√≠stico-culturales'],
        desempenos: {
          '1¬∞ Secundaria': 'Describe las caracter√≠sticas de diversas manifestaciones art√≠sticas, relacion√°ndolas con su contexto cultural y temporal.',
          '2¬∞ Secundaria': 'Analiza manifestaciones art√≠sticas de diferentes culturas y per√≠odos, argumentando sus juicios est√©ticos.',
          '3¬∞ Secundaria': 'Interpreta el significado de obras art√≠sticas en su contexto hist√≥rico y cultural, reflexionando sobre su impacto.',
          '4¬∞ Secundaria': 'Eval√∫a cr√≠ticamente manifestaciones art√≠sticas contempor√°neas, reconociendo su valor cultural e identitario.',
          '5¬∞ Secundaria': 'Elabora juicios cr√≠ticos fundamentados sobre manifestaciones art√≠sticas en relaci√≥n con procesos sociales y culturales.'
        }
      },
      {
        nombre: 'Crea proyectos desde los lenguajes art√≠sticos',
        capacidades: ['Explora y experimenta los lenguajes del arte','Aplica procesos creativos','Eval√∫a y socializa sus procesos y proyectos creativos'],
        desempenos: {
          '1¬∞ Secundaria': 'Crea trabajos art√≠sticos usando elementos del lenguaje visual, musical, corporal o dram√°tico, compartiendo su proceso.',
          '2¬∞ Secundaria': 'Desarrolla proyectos art√≠sticos con intenci√≥n expresiva clara, aplicando t√©cnicas y reflexionando sobre su proceso.',
          '3¬∞ Secundaria': 'Crea proyectos art√≠sticos que transmiten ideas y emociones, usando recursos t√©cnicos y conceptuales del arte.',
          '4¬∞ Secundaria': 'Dise√±a y ejecuta proyectos art√≠sticos con prop√≥sito est√©tico-comunicativo, integrando investigaci√≥n y reflexi√≥n.',
          '5¬∞ Secundaria': 'Desarrolla proyectos art√≠sticos originales con identidad propia, evaluando su proceso creativo y su impacto en la audiencia.'
        }
      }
    ]
  },
  'Educaci√≥n Religiosa': {
    competencias: [
      {
        nombre: 'Construye su identidad como persona humana, amada por Dios, digna, libre y trascendente',
        capacidades: ['Conoce a Dios y asume su identidad religiosa y espiritual','Cultiva y valora las manifestaciones religiosas de su entorno argumentando su fe'],
        desempenos: {
          '1¬∞ Secundaria': 'Reflexiona sobre la dignidad humana desde la perspectiva cristiana, relacionando su fe con su identidad personal.',
          '2¬∞ Secundaria': 'Analiza el mensaje evang√©lico y su relevancia para la vida en comunidad, valorando las tradiciones religiosas.',
          '3¬∞ Secundaria': 'Argumenta sobre la trascendencia humana desde la fe, valorando el di√°logo ecum√©nico e interreligioso.',
          '4¬∞ Secundaria': 'Integra los valores evang√©licos en su proyecto de vida, reflexionando sobre su responsabilidad social.',
          '5¬∞ Secundaria': 'Construye su identidad trascendente con madurez y autonom√≠a, comprometido con el bien com√∫n desde su fe.'
        }
      },
      {
        nombre: 'Asume la experiencia del encuentro personal y comunitario con Dios en su proyecto de vida',
        capacidades: ['Transforma su entorno desde el encuentro personal y comunitario con Dios','Act√∫a coherentemente en raz√≥n de su fe seg√∫n los principios de su conciencia moral'],
        desempenos: {
          '1¬∞ Secundaria': 'Practica valores evang√©licos en su vida cotidiana, reconociendo el papel de la comunidad cristiana en su crecimiento.',
          '2¬∞ Secundaria': 'Vive su fe en el servicio a los dem√°s, participando en actividades de proyecci√≥n social.',
          '3¬∞ Secundaria': 'Act√∫a coherentemente seg√∫n sus principios morales, tomando decisiones fundamentadas en el Evangelio.',
          '4¬∞ Secundaria': 'Dise√±a acciones de servicio comunitario basadas en la doctrina social de la Iglesia.',
          '5¬∞ Secundaria': 'Lidera compromisos de servicio y solidaridad desde su fe, articulando su proyecto de vida con el bien com√∫n.'
        }
      }
    ]
  },
  'Ingl√©s como Lengua Extranjera': {
    competencias: [
      {
        nombre: 'Se comunica oralmente en ingl√©s como lengua extranjera',
        capacidades: ['Obtiene informaci√≥n del texto oral','Infiere e interpreta informaci√≥n del texto oral','Adec√∫a, organiza y desarrolla las ideas de forma coherente','Utiliza recursos no verbales y paraverbales','Interact√∫a estrat√©gicamente','Reflexiona y eval√∫a'],
        desempenos: {
          '1¬∞ Secundaria': 'Comprende y produce enunciados sencillos en ingl√©s para comunicarse sobre temas cotidianos y familiares (A1-A2).',
          '2¬∞ Secundaria': 'Interact√∫a en conversaciones b√°sicas sobre temas de su inter√©s usando vocabulario elemental y expresiones funcionales (A2).',
          '3¬∞ Secundaria': 'Participa en intercambios comunicativos sobre temas variados, usando estructuras simples con fluidez b√°sica (A2-B1).',
          '4¬∞ Secundaria': 'Sostiene conversaciones sobre temas conocidos y de actualidad, expresando opiniones con vocabulario ampliado (B1).',
          '5¬∞ Secundaria': 'Comunica ideas complejas, argumenta y participa en debates acad√©micos en ingl√©s con cierta fluidez (B1-B2).'
        }
      },
      {
        nombre: 'Lee diversos tipos de textos en ingl√©s como lengua extranjera',
        capacidades: ['Obtiene informaci√≥n del texto','Infiere e interpreta informaci√≥n','Reflexiona y eval√∫a'],
        desempenos: {
          '1¬∞ Secundaria': 'Lee textos muy cortos y sencillos en ingl√©s, identificando informaci√≥n expl√≠cita sobre temas conocidos (A1).',
          '2¬∞ Secundaria': 'Lee textos breves en ingl√©s sobre temas cotidianos, deduciendo el significado de palabras por contexto (A2).',
          '3¬∞ Secundaria': 'Lee textos en ingl√©s de mediana extensi√≥n, identificando ideas principales y detalles relevantes (A2-B1).',
          '4¬∞ Secundaria': 'Lee textos aut√©nticos en ingl√©s de diversa naturaleza, interpretando el prop√≥sito e intenci√≥n del autor (B1).',
          '5¬∞ Secundaria': 'Lee y eval√∫a cr√≠ticamente textos complejos en ingl√©s, reconociendo perspectivas y argumentando en torno a su contenido (B1-B2).'
        }
      },
      {
        nombre: 'Escribe diversos tipos de textos en ingl√©s como lengua extranjera',
        capacidades: ['Adec√∫a el texto a la situaci√≥n comunicativa','Organiza y desarrolla las ideas','Utiliza convenciones del lenguaje escrito','Reflexiona y eval√∫a'],
        desempenos: {
          '1¬∞ Secundaria': 'Escribe textos muy cortos y sencillos en ingl√©s usando vocabulario y estructuras b√°sicas aprendidas (A1).',
          '2¬∞ Secundaria': 'Produce textos breves en ingl√©s sobre temas familiares usando conectores simples y vocabulario elemental (A2).',
          '3¬∞ Secundaria': 'Escribe textos coherentes en ingl√©s sobre temas variados, usando estructuras gramaticales b√°sicas con correcci√≥n (A2-B1).',
          '4¬∞ Secundaria': 'Produce textos organizados en ingl√©s con vocabulario ampliado, revisando y mejorando su producci√≥n (B1).',
          '5¬∞ Secundaria': 'Escribe textos argumentativos y formales en ingl√©s con estructura clara y uso adecuado de recursos ling√º√≠sticos (B1-B2).'
        }
      }
    ]
  },
  'Educaci√≥n para el Trabajo': {
    competencias: [
      {
        nombre: 'Gestiona proyectos de emprendimiento econ√≥mico y social',
        capacidades: ['Crea propuestas de valor','Aplica habilidades t√©cnicas','Trabaja cooperativamente para lograr objetivos y metas','Eval√∫a los resultados del proyecto de emprendimiento'],
        desempenos: {
          '1¬∞ Secundaria': 'Identifica oportunidades de negocio en su entorno y dise√±a una propuesta b√°sica de emprendimiento con apoyo.',
          '2¬∞ Secundaria': 'Dise√±a un plan de negocio sencillo, identificando recursos, costos y beneficios potenciales.',
          '3¬∞ Secundaria': 'Desarrolla un proyecto de emprendimiento aplicando habilidades t√©cnicas del √°rea y evaluando su viabilidad.',
          '4¬∞ Secundaria': 'Ejecuta proyectos de emprendimiento, aplicando estrategias de marketing y evaluando su impacto econ√≥mico y social.',
          '5¬∞ Secundaria': 'Gestiona proyectos de emprendimiento innovadores, analizando el mercado y evaluando su sostenibilidad e impacto.'
        }
      }
    ]
  }
};

// =============================================
// HELPER ‚Äì get CNEB data for area
// =============================================
function getCnebData(area){
  return CNEB[area] || CNEB['Comunicaci√≥n'];
}

function onAreaChange(prefix){
  const area = document.getElementById(prefix+'Area').value;
  const grado = document.getElementById(prefix+'Grado').value;
  const data = getCnebData(area);

  // Render clickable tags panel
  const panelEl = document.getElementById(prefix+'CnebCompetencias');
  if(panelEl){
    panelEl.innerHTML = data.competencias.map((c,i)=>
      `<span class="cneb-tag" onclick="selectCompetencia('${prefix}',${i})">${c.nombre}</span>`
    ).join('');
  }

  // Populate competencia select (for sesion)
  const sel = document.getElementById(prefix+'Competencia');
  if(sel){
    sel.innerHTML = '<option value="">-- Selecciona una competencia --</option>' +
      data.competencias.map((c,i)=>`<option value="${i}">${c.nombre}</option>`).join('');
    document.getElementById(prefix+'Capacidades').innerHTML =
      '<span style="color:var(--muted)">Selecciona una competencia para ver las capacidades</span>';
    document.getElementById(prefix+'Desempeno').value = '';
  }

  // For uni/plan: auto-fill competencias textarea
  const compTA = document.getElementById(prefix+'Competencias');
  if(compTA){
    compTA.value = data.competencias.map(c=>c.nombre).join('\n');
  }
}

function selectCompetencia(prefix, idx){
  const area = document.getElementById(prefix+'Area').value;
  const grado = document.getElementById(prefix+'Grado').value;
  const data = getCnebData(area);
  const comp = data.competencias[idx];

  // For sesion: set select and update fields
  const sel = document.getElementById(prefix+'Competencia');
  if(sel){
    sel.value = String(idx);
    onCompetenciaChange(prefix);
    return;
  }

  // For uni/plan: toggle competencia in textarea
  const compTA = document.getElementById(prefix+'Competencias');
  if(compTA){
    const current = compTA.value;
    if(current.includes(comp.nombre)){
      compTA.value = current.split('\n').filter(l=>l.trim()!==comp.nombre).join('\n');
    } else {
      compTA.value = current ? current + '\n' + comp.nombre : comp.nombre;
    }
  }
}

function onCompetenciaChange(prefix){
  const area = document.getElementById(prefix+'Area').value;
  const grado = document.getElementById(prefix+'Grado').value;
  const idx = parseInt(document.getElementById(prefix+'Competencia').value);
  if(isNaN(idx)) return;
  const data = getCnebData(area);
  const comp = data.competencias[idx];

  // Render capacidades as checkboxes (all checked by default)
  const container = document.getElementById(prefix+'Capacidades');
  container.innerHTML =
    '<div style="display:flex;flex-direction:column;gap:.4rem;padding:.3rem 0">' +
    comp.capacidades.map((c, i) =>
      `<label style="display:flex;align-items:flex-start;gap:.55rem;cursor:pointer;padding:.35rem .5rem;border-radius:6px;background:#f0fdf9;border:1px solid #a7f3d0;transition:background .15s" onmouseover="this.style.background=\'#d1fae5\'" onmouseout="this.style.background=\'#f0fdf9\'">
        <input type="checkbox" value="${c}" checked
          style="margin-top:.18rem;accent-color:#0d9488;width:15px;height:15px;flex-shrink:0">
        <span style="font-size:.82rem;color:#1a2a3a;line-height:1.4">${c}</span>
      </label>`
    ).join('') +
    '</div>';

  const desTA = document.getElementById(prefix+'Desempeno');
  if(desTA) desTA.value = comp.desempenos[grado] || comp.desempenos['1¬∞ Secundaria'];
}

function getSelectedCaps(prefix){
  const container = document.getElementById(prefix+'Capacidades');
  if(!container) return [];
  return Array.from(container.querySelectorAll('input[type=checkbox]:checked')).map(cb => cb.value);
}

function toggleAllCaps(prefix){
  const container = document.getElementById(prefix+'Capacidades');
  if(!container) return;
  const checkboxes = container.querySelectorAll('input[type=checkbox]');
  const allChecked = Array.from(checkboxes).every(cb => cb.checked);
  checkboxes.forEach(cb => cb.checked = !allChecked);
}

// =============================================
// AUTH & NAV
// =============================================
const loginForm = document.getElementById('loginForm');
loginForm.addEventListener('submit', e=>{e.preventDefault(); enterApp()});

function enterApp(){
  const email = document.getElementById('loginEmail').value || '';
  const name = email.includes('@') ? email.split('@')[0] : (email || 'Docente');
  document.getElementById('userName').textContent = name;
  document.getElementById('welcomeName').textContent = name;
  document.getElementById('authPage').classList.add('hidden');
  document.getElementById('appShell').classList.remove('hidden');
  updateStats(); renderRecent();
  updateApiKeyBadge();
  // Init CNEB panels
  ['ses','uni','plan'].forEach(p => {
    if(document.getElementById(p+'Area')) onAreaChange(p);
  });
}

function logout(){
  document.getElementById('appShell').classList.add('hidden');
  document.getElementById('authPage').classList.remove('hidden');
  document.getElementById('loginEmail').value = '';
  document.getElementById('loginPass').value = '';
}

function showPage(id, el){
  document.querySelectorAll('[id^=page-]').forEach(p=>p.classList.add('hidden'));
  document.getElementById('page-'+id).classList.remove('hidden');
  document.querySelectorAll('.sidebar nav a').forEach(a=>a.classList.remove('active'));
  if(el) el.classList.add('active');
  document.getElementById('sidebar').classList.remove('open');
  if(id==='documentos') filterDocs('all', document.getElementById('tab-all'));
  if(id==='asistente'){
    const sug = document.getElementById('chatSuggestions');
    const msgs = document.getElementById('chatMessages');
    if(msgs.querySelectorAll('.chat-msg').length <= 1) sug.style.display = '';
  }
}

function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('open') }

// =============================================
// FILE DROP FEEDBACK
// =============================================
function showFileName(dropId, input){
  const drop = document.getElementById(dropId);
  if(input.files && input.files[0]){
    drop.innerHTML = `‚úÖ <strong>${input.files[0].name}</strong><br><small style="color:var(--primary)">Haz clic para cambiar</small>`;
    drop.appendChild(input);
  }
}

// =============================================
// STORAGE
// =============================================
let docs = JSON.parse(localStorage.getItem('neurosim_docs') || '[]');
function saveDocs(){ localStorage.setItem('neurosim_docs', JSON.stringify(docs)) }

function updateStats(){
  document.getElementById('statDocs').textContent = docs.length;
  document.getElementById('statSes').textContent = docs.filter(d=>d.type==='sesion').length;
  document.getElementById('statUni').textContent = docs.filter(d=>d.type==='unidad').length;
  document.getElementById('statPlan').textContent = docs.filter(d=>d.type==='plan').length;
}

function renderRecent(){
  const el = document.getElementById('recentList');
  if(!docs.length){ el.innerHTML='<p style="color:var(--muted);font-size:.85rem">A√∫n no has generado documentos.</p>'; return; }
  el.innerHTML = docs.slice(-5).reverse().map(d=>`
    <div class="card" style="cursor:pointer" onclick="viewDoc('${d.id}')">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong style="font-size:.9rem">${escapeHtml(d.title)}</strong><br><small style="color:var(--muted)">${d.date} ¬∑ ${d.area} ¬∑ ${d.grado}</small></div>
        <span class="badge">${d.type==='sesion'?'Sesi√≥n':d.type==='unidad'?'Unidad':'Plan Anual'}</span>
      </div>
    </div>`).join('');
}

// =============================================
// AI GENERATION via Anthropic API
// =============================================
// =============================================
// API KEY MANAGEMENT
// =============================================
function getApiKey(){ return localStorage.getItem('neurosim_apikey') || ''; }

function saveApiKey(){
  const key = document.getElementById('apikeyInput').value.trim();
  if(!key.startsWith('sk-ant-')){
    alert('‚ö†Ô∏è La API Key debe empezar con "sk-ant-". Verifica que la copiaste correctamente.');
    return;
  }
  localStorage.setItem('neurosim_apikey', key);
  updateApiKeyBadge();
  closeApiKeyModal();
}

function openApiKeyModal(){
  const k = getApiKey();
  if(k) document.getElementById('apikeyInput').value = k;
  document.getElementById('apikeyModal').classList.remove('hidden');
}

function closeApiKeyModal(){
  document.getElementById('apikeyModal').classList.add('hidden');
}

function toggleApiKeyVisibility(){
  const inp = document.getElementById('apikeyInput');
  const btn = document.getElementById('eyeBtn');
  if(inp.type === 'password'){ inp.type = 'text'; btn.textContent = 'üôà'; }
  else { inp.type = 'password'; btn.textContent = 'üëÅ'; }
}

function updateApiKeyBadge(){
  const badge = document.getElementById('apikeyBadge');
  const status = document.getElementById('apikeyStatus');
  if(!badge || !status) return;
  const k = getApiKey();
  if(k){
    badge.classList.add('connected');
    status.textContent = 'IA Conectada ‚úì';
  } else {
    badge.classList.remove('connected');
    status.textContent = 'Conectar API Key';
  }
}

// Close modal on backdrop click
document.addEventListener('click', e => {
  if(e.target.id === 'apikeyModal') closeApiKeyModal();
});

// =============================================
// CLAUDE API CALL (CORS enabled for browser)
// =============================================
async function callClaude(systemPrompt, userPrompt, btnId, btnLabel){
  const apiKey = getApiKey();
  if(!apiKey){
    openApiKeyModal();
    throw new Error('Ingresa tu API Key de Anthropic para continuar');
  }
  const btn = document.getElementById(btnId);
  const label = btnLabel || '‚ú® Generar con IA';
  if(btn){ btn.disabled = true; btn.innerHTML = '<span class="loading"></span> Generando con IA...'; }
  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        system: systemPrompt,
        messages: [{ role: 'user', content: userPrompt }]
      })
    });
    if(!response.ok){
      const err = await response.json().catch(()=>({}));
      const msg = err.error?.message || `Error HTTP ${response.status}`;
      if(response.status === 401) throw new Error('API Key inv√°lida. Verifica que sea correcta en el bot√≥n üîë de la barra lateral.');
      if(response.status === 429) throw new Error('L√≠mite de uso alcanzado. Espera un momento e intenta de nuevo.');
      throw new Error(msg);
    }
    const data = await response.json();
    if(data.error) throw new Error(data.error.message);
    return data.content.map(b=>b.text||'').join('');
  } catch(e) {
    throw e;
  } finally {
    if(btn){ btn.disabled = false; btn.innerHTML = label; }
  }
}

// =============================================
// PROMPTS SISTEMA ‚Äì Documentos CNEB
// =============================================
const SYSTEM_SESION = `Eres un experto pedagogo peruano especializado en el Curr√≠culo Nacional de Educaci√≥n B√°sica (CNEB) del MINEDU Per√∫. Generas sesiones de aprendizaje profesionales para nivel secundaria en formato HTML sem√°ntico.

Debes generar el contenido en HTML puro usando SOLO estas clases CSS disponibles: header-doc, section-box, moment-inicio, moment-desarrollo, moment-cierre, badge-nivel, tip-box. Tambi√©n puedes usar: h2, h3, table, th, td, tr, ul, li, p, strong, em.

ESTRUCTURA OBLIGATORIA DE LA SESI√ìN (sigue esta secuencia exacta):
1. header-doc: T√≠tulo y datos de la sesi√≥n
2. h2: I. DATOS INFORMATIVOS ‚Üí tabla con los datos
3. h2: II. PROP√ìSITO DE APRENDIZAJE ‚Üí tabla: Competencia | Capacidades | Desempe√±o precisado | Instrumento
4. h2: III. ENFOQUE TRANSVERSAL ‚Üí descripci√≥n, valor y actitud observable
5. h2: IV. PREPARACI√ìN DE LA SESI√ìN ‚Üí tabla: ¬øQu√© necesitamos hacer antes de la sesi√≥n? | ¬øQu√© recursos o materiales se utilizar√°n?
6. h2: V. SECUENCIA DID√ÅCTICA ‚Üí 3 bloques:
   - div class="section-box moment-inicio": INICIO con tiempo, actividades detalladas, preguntas de activaci√≥n
   - div class="section-box moment-desarrollo": DESARROLLO con actividades paso a paso, estrategias, gesti√≥n del tiempo
   - div class="section-box moment-cierre": CIERRE con metacognici√≥n, evaluaci√≥n formativa, extensi√≥n
7. h2: VI. EVALUACI√ìN FORMATIVA ‚Üí tabla: Competencia | Criterios | Instrumento | Escala
8. h2: VII. DIFERENCIACI√ìN PEDAG√ìGICA ‚Üí tip-box con sugerencias para estudiantes con diferentes ritmos
9. h2: VIII. REFERENCIAS ‚Üí lista bibliogr√°fica MINEDU

Genera contenido REAL y ESPEC√çFICO para el √°rea y grado. NO uses texto gen√©rico. Cada actividad debe ser concreta, con ejemplos reales del √°rea curricular. Los tiempos deben sumar exactamente la duraci√≥n total indicada. Responde SOLO con HTML, sin markdown ni explicaciones.`;

const SYSTEM_UNIDAD = `Eres un experto pedagogo peruano especializado en el CNEB MINEDU Per√∫. Generas unidades did√°cticas completas y profesionales para nivel secundaria en formato HTML.

Usa SOLO estas clases CSS: header-doc, section-box, badge-nivel, tip-box, y etiquetas: h2, h3, table, th, td, tr, ul, li, p, strong, em.

ESTRUCTURA OBLIGATORIA DE LA UNIDAD DID√ÅCTICA:
1. header-doc: Nombre de la unidad, n√∫mero, √°rea, grado
2. h2: I. DATOS INFORMATIVOS ‚Üí tabla completa
3. h2: II. SITUACI√ìN SIGNIFICATIVA ‚Üí p√°rrafo narrativo contextualizado, pregunta retadora
4. h2: III. PROP√ìSITOS DE APRENDIZAJE ‚Üí tabla: Competencia | Capacidades | Desempe√±os | Evidencia | Instrumento
5. h2: IV. ENFOQUES TRANSVERSALES ‚Üí tabla: Enfoque | Valor | Actitudes observables
6. h2: V. SECUENCIA DE SESIONES ‚Üí tabla detallada: N¬∞ sesi√≥n | T√≠tulo | Actividades principales | Recursos | Duraci√≥n
7. h2: VI. CAMPO TEM√ÅTICO ‚Üí lista de contenidos organizados por sesi√≥n
8. h2: VII. ESTRATEGIAS METODOL√ìGICAS ‚Üí tip-box con metodolog√≠as activas sugeridas
9. h2: VIII. CRITERIOS DE EVALUACI√ìN ‚Üí tabla: Competencia | Criterios | Instrumento | Escala CNEB (AD/A/B/C)
10. h2: IX. MATERIALES Y RECURSOS ‚Üí lista organizada
11. h2: X. REFERENCIAS BIBLIOGR√ÅFICAS ‚Üí lista MINEDU oficial

Genera contenido ESPEC√çFICO y REAL para el √°rea. Responde SOLO con HTML.`;

const SYSTEM_PLAN = `Eres un experto pedagogo peruano especializado en el CNEB MINEDU Per√∫. Generas planificaciones curriculares anuales completas y oficiales para nivel secundaria en formato HTML.

Usa SOLO estas clases CSS: header-doc, section-box, badge-nivel, tip-box, y etiquetas: h2, h3, table, th, td, tr, ul, li, p, strong, em.

ESTRUCTURA OBLIGATORIA DE LA PLANIFICACI√ìN ANUAL:
1. header-doc: Encabezado oficial con datos de la I.E.
2. h2: I. DATOS INFORMATIVOS ‚Üí tabla con todos los datos institucionales
3. h2: II. PRESENTACI√ìN DEL √ÅREA ‚Üí descripci√≥n del enfoque del √°rea seg√∫n el CNEB para el grado
4. h2: III. COMPETENCIAS Y CAPACIDADES DEL √ÅREA ‚Üí tabla: Competencia | Capacidades | Est√°ndar de aprendizaje (nivel VI/VII)
5. h2: IV. SITUACIONES SIGNIFICATIVAS ANUALES ‚Üí descripci√≥n de los grandes retos/problemas del a√±o
6. h2: V. ORGANIZACI√ìN DE UNIDADES DID√ÅCTICAS ‚Üí tabla: N¬∞ | T√≠tulo | Situaci√≥n significativa | Competencias | Campo tem√°tico | Meses | Sesiones
7. h2: VI. ENFOQUES TRANSVERSALES ‚Üí tabla: Enfoque | Valores | Actitudes docentes y estudiantes
8. h2: VII. COMPETENCIAS TRANSVERSALES ‚Üí Se desenvuelve en entornos virtuales y Gestiona su aprendizaje aut√≥nomo
9. h2: VIII. DISTRIBUCI√ìN DEL TIEMPO ‚Üí tabla con semanas, horas pedag√≥gicas por bimestre
10. h2: IX. EVALUACI√ìN ‚Üí estrategias e instrumentos por competencia
11. h2: X. REFERENCIAS BIBLIOGR√ÅFICAS

Genera una planificaci√≥n COMPLETA, REAL y ESPEC√çFICA para el √°rea y grado. Responde SOLO con HTML.`;

// =============================================
// GENERATORS
// =============================================
async function generarSesionIA(){
  const area = document.getElementById('sesArea').value;
  const grado = document.getElementById('sesGrado').value;
  const titulo = document.getElementById('sesTitulo').value || 'Sesi√≥n de Aprendizaje';
  const selIdx = document.getElementById('sesCompetencia').value;
  const data = getCnebData(area);
  const comp = selIdx !== '' ? data.competencias[parseInt(selIdx)] : data.competencias[0];
  const competenciaNombre = comp ? comp.nombre : '';
  const selectedCaps = getSelectedCaps('ses');
  const capacidades = selectedCaps.length > 0 ? selectedCaps.join(', ') : (comp ? comp.capacidades.join(', ') : '');
  const desempeno = document.getElementById('sesDesempeno').value || (comp ? comp.desempenos[grado] : '');
  const duracion = parseInt(document.getElementById('sesDuracion').value) || 90;
  const estudiantes = document.getElementById('sesEstudiantes').value || 30;
  const enfoque = document.getElementById('sesEnfoque').value;
  const contexto = document.getElementById('sesContexto').value;
  const docente = document.getElementById('userName').textContent;
  const file = document.getElementById('sesFile').files[0];

  const outputEl = document.getElementById('sesOutput');
  outputEl.innerHTML = `<div class="gen-loading"><span class="loading"></span> La IA est√° generando tu sesi√≥n de aprendizaje completa... esto puede tomar unos segundos.</div>`;

  const prompt = `Genera una SESI√ìN DE APRENDIZAJE completa y detallada para:

DATOS:
- √Årea Curricular: ${area}
- Grado: ${grado}
- T√≠tulo: "${titulo}"
- Competencia: ${competenciaNombre}
- Capacidades: ${capacidades}
- Desempe√±o precisado: ${desempeno}
- Duraci√≥n total: ${duracion} minutos
- N√∫mero de estudiantes: ${estudiantes}
- Enfoque transversal: ${enfoque}
- Contexto/Situaci√≥n significativa: ${contexto || 'Contexto local de la regi√≥n Per√∫, situaci√≥n relevante para adolescentes de secundaria'}
- Docente: ${docente}
- Archivo de referencia: ${file ? file.name : 'No adjuntado'}
- Fecha: ${new Date().toLocaleDateString('es-PE')}

Genera la sesi√≥n completa siguiendo la estructura CNEB oficial. El INICIO debe durar ${Math.round(duracion*0.17)} min, el DESARROLLO ${duracion - Math.round(duracion*0.17)*2} min y el CIERRE ${Math.round(duracion*0.17)} min. Incluye actividades CONCRETAS y espec√≠ficas para el √°rea ${area}.`;

  try {
    const html = await callClaude(SYSTEM_SESION, prompt, 'btnGenSes', '‚ú® Generar Sesi√≥n con IA');
    const doc = {
      id: Date.now().toString(), type: 'sesion',
      title: titulo, area, grado,
      date: new Date().toLocaleDateString('es-PE'),
      content: html, isHtml: true
    };
    docs.push(doc); saveDocs(); updateStats(); renderRecent();
    outputEl.innerHTML = `
      <div class="output-rendered">${html}</div>
      <div style="margin-top:.8rem;display:flex;gap:.5rem;flex-wrap:wrap">
        <button class="btn btn-primary btn-sm" onclick="downloadDocHtml('${doc.id}')" style="width:auto">üì• Descargar HTML</button>
        <button class="btn btn-outline btn-sm" onclick="printDoc('${doc.id}')" style="width:auto">üñ®Ô∏è Imprimir / PDF</button>
        <button class="btn btn-outline btn-sm" onclick="copyDocContent('${doc.id}')" style="width:auto">üìã Copiar texto</button>
      </div>`;
  } catch(e){
    outputEl.innerHTML = `<div style="color:#dc2626;padding:1rem;background:#fef2f2;border-radius:8px">‚ùå Error al generar: ${e.message}. Verifica tu conexi√≥n.</div>`;
    document.getElementById('btnGenSes').disabled = false;
    if(document.getElementById('btnGenSes')) document.getElementById('btnGenSes').innerHTML = '‚ú® Generar Sesi√≥n con IA';
  }
}

async function generarUnidadIA(){
  const area = document.getElementById('uniArea').value;
  const grado = document.getElementById('uniGrado').value;
  const titulo = document.getElementById('uniTitulo').value || 'Unidad Did√°ctica';
  const numero = document.getElementById('uniNumero').value;
  const numSes = document.getElementById('uniSesiones').value;
  const competencias = document.getElementById('uniCompetencias').value;
  const situacion = document.getElementById('uniSituacion').value;
  const enfoques = document.getElementById('uniEnfoques').value;
  const docente = document.getElementById('userName').textContent;

  const outputEl = document.getElementById('uniOutput');
  outputEl.innerHTML = `<div class="gen-loading"><span class="loading"></span> Generando Unidad Did√°ctica con IA... espera un momento.</div>`;

  const prompt = `Genera una UNIDAD DID√ÅCTICA completa para:

DATOS:
- √Årea: ${area}
- Grado: ${grado}
- N√∫mero de Unidad: ${numero}
- T√≠tulo: "${titulo}"
- N√∫mero de sesiones: ${numSes}
- Competencias: ${competencias}
- Situaci√≥n significativa: ${situacion || 'Situaci√≥n relevante del contexto local/regional peruano para adolescentes'}
- Enfoques transversales: ${enfoques}
- Docente: ${docente}
- A√±o: 2026

Para la secuencia de sesiones, genera ${numSes} sesiones con t√≠tulos creativos y actividades espec√≠ficas para ${area} en ${grado}. Las evidencias deben ser medibles y los instrumentos coherentes con las competencias CNEB.`;

  try {
    const html = await callClaude(SYSTEM_UNIDAD, prompt, 'btnGenUni', '‚ú® Generar Unidad con IA');
    const doc = {
      id: Date.now().toString(), type: 'unidad',
      title: titulo, area, grado,
      date: new Date().toLocaleDateString('es-PE'),
      content: html, isHtml: true
    };
    docs.push(doc); saveDocs(); updateStats(); renderRecent();
    outputEl.innerHTML = `
      <div class="output-rendered">${html}</div>
      <div style="margin-top:.8rem;display:flex;gap:.5rem;flex-wrap:wrap">
        <button class="btn btn-primary btn-sm" onclick="downloadDocHtml('${doc.id}')" style="width:auto">üì• Descargar HTML</button>
        <button class="btn btn-outline btn-sm" onclick="printDoc('${doc.id}')" style="width:auto">üñ®Ô∏è Imprimir / PDF</button>
        <button class="btn btn-outline btn-sm" onclick="copyDocContent('${doc.id}')" style="width:auto">üìã Copiar texto</button>
      </div>`;
  } catch(e){
    outputEl.innerHTML = `<div style="color:#dc2626;padding:1rem;background:#fef2f2;border-radius:8px">‚ùå Error al generar: ${e.message}</div>`;
    document.getElementById('btnGenUni').disabled = false;
    if(document.getElementById('btnGenUni')) document.getElementById('btnGenUni').innerHTML = '‚ú® Generar Unidad con IA';
  }
}

async function generarPlanAnualIA(){
  const area = document.getElementById('planArea').value;
  const grado = document.getElementById('planGrado').value;
  const anio = document.getElementById('planAnio').value;
  const numUni = document.getElementById('planUnidades').value;
  const ie = document.getElementById('planIE').value || 'I.E. N¬∞ XXXXX';
  const competencias = document.getElementById('planCompetencias').value;
  const desc = document.getElementById('planDesc').value;
  const docente = document.getElementById('userName').textContent;

  const outputEl = document.getElementById('planOutput');
  outputEl.innerHTML = `<div class="gen-loading"><span class="loading"></span> Generando Planificaci√≥n Anual con IA... esto puede tomar unos momentos.</div>`;

  const prompt = `Genera una PLANIFICACI√ìN CURRICULAR ANUAL completa y oficial para:

DATOS:
- Instituci√≥n Educativa: ${ie}
- √Årea Curricular: ${area}
- Grado: ${grado}
- A√±o Lectivo: ${anio}
- N√∫mero de Unidades: ${numUni}
- Competencias: ${competencias}
- Descripci√≥n del √°rea: ${desc || 'Descripci√≥n seg√∫n el Programa Curricular de Educaci√≥n Secundaria MINEDU'}
- Docente: ${docente}
- Horas semanales: ${area === 'Matem√°tica' || area === 'Comunicaci√≥n' ? 5 : area === 'Ingl√©s como Lengua Extranjera' ? 3 : 2} horas pedag√≥gicas

Genera ${numUni} unidades did√°cticas distribuidas en los bimestres del a√±o lectivo peruano (Marzo-Diciembre). Cada unidad debe tener un t√≠tulo significativo y competencias espec√≠ficas del √°rea ${area}.`;

  try {
    const html = await callClaude(SYSTEM_PLAN, prompt, 'btnGenPlan', '‚ú® Generar Planificaci√≥n con IA');
    const doc = {
      id: Date.now().toString(), type: 'plan',
      title: `Plan Anual ${area} ${grado} ${anio}`, area, grado,
      date: new Date().toLocaleDateString('es-PE'),
      content: html, isHtml: true
    };
    docs.push(doc); saveDocs(); updateStats(); renderRecent();
    outputEl.innerHTML = `
      <div class="output-rendered">${html}</div>
      <div style="margin-top:.8rem;display:flex;gap:.5rem;flex-wrap:wrap">
        <button class="btn btn-primary btn-sm" onclick="downloadDocHtml('${doc.id}')" style="width:auto">üì• Descargar HTML</button>
        <button class="btn btn-outline btn-sm" onclick="printDoc('${doc.id}')" style="width:auto">üñ®Ô∏è Imprimir / PDF</button>
        <button class="btn btn-outline btn-sm" onclick="copyDocContent('${doc.id}')" style="width:auto">üìã Copiar texto</button>
      </div>`;
  } catch(e){
    outputEl.innerHTML = `<div style="color:#dc2626;padding:1rem;background:#fef2f2;border-radius:8px">‚ùå Error al generar: ${e.message}</div>`;
    document.getElementById('btnGenPlan').disabled = false;
    if(document.getElementById('btnGenPlan')) document.getElementById('btnGenPlan').innerHTML = '‚ú® Generar Planificaci√≥n con IA';
  }
}

// =============================================
// DOCUMENTS MANAGEMENT
// =============================================
function filterDocs(type, el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  if(el) el.classList.add('active');
  const filtered = type==='all' ? docs : docs.filter(d=>d.type===type);
  renderDocsList(filtered);
}

function renderDocsList(list){
  const el = document.getElementById('docsList');
  if(!list||!list.length){ el.innerHTML='<p style="color:var(--muted);font-size:.85rem">No hay documentos en esta categor√≠a.</p>'; return; }
  el.innerHTML = list.map(d=>`
    <div class="card" style="cursor:pointer" onclick="viewDoc('${d.id}')">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>${escapeHtml(d.title)}</strong><br><small style="color:var(--muted)">${d.date} ¬∑ ${d.area} ¬∑ ${d.grado}</small></div>
        <div style="display:flex;gap:.4rem;align-items:center">
          <span class="badge">${d.type==='sesion'?'Sesi√≥n':d.type==='unidad'?'Unidad':'Plan Anual'}</span>
          <button class="btn btn-sm btn-outline" onclick="event.stopPropagation();deleteDoc('${d.id}')" style="width:auto;padding:.3rem .6rem;font-size:.7rem;color:#f87171">üóë</button>
        </div>
      </div>
    </div>`).join('');
}

function viewDoc(id){
  const doc = docs.find(d=>d.id===id);
  if(!doc) return;
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:100;display:flex;align-items:center;justify-content:center;padding:1rem';
  const content = doc.isHtml
    ? `<div class="output-rendered" style="max-height:none">${doc.content}</div>`
    : `<pre style="white-space:pre-wrap;font-size:.82rem;line-height:1.7;font-family:var(--font)">${escapeHtml(doc.content)}</pre>`;
  modal.innerHTML = `
    <div style="background:#fff;border-radius:16px;max-width:860px;width:100%;max-height:90vh;overflow-y:auto;padding:2rem">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
        <h2 style="font-size:1.1rem;font-weight:700">${escapeHtml(doc.title)}</h2>
        <button id="modalClose" style="background:none;border:none;font-size:1.4rem;cursor:pointer">‚úï</button>
      </div>
      ${content}
      <div style="margin-top:1rem;display:flex;gap:.5rem;flex-wrap:wrap">
        <button class="btn btn-primary btn-sm" onclick="downloadDocHtml('${doc.id}')" style="width:auto">üì• Descargar HTML</button>
        <button class="btn btn-outline btn-sm" onclick="printDoc('${doc.id}')" style="width:auto">üñ®Ô∏è Imprimir</button>
      </div>
    </div>`;
  modal.addEventListener('click', e=>{ if(e.target===modal) modal.remove() });
  document.body.appendChild(modal);
  document.getElementById('modalClose').addEventListener('click', ()=>modal.remove());
}

function deleteDoc(id){
  if(!confirm('¬øEliminar este documento?')) return;
  docs = docs.filter(d=>d.id!==id); saveDocs(); updateStats(); renderRecent();
  const activeTab = document.querySelector('#page-documentos .tab.active') || document.getElementById('tab-all');
  const activeType = activeTab.id.replace('tab-','');
  filterDocs(activeType, activeTab);
}

function downloadDocHtml(id){
  const doc = docs.find(d=>d.id===id); if(!doc) return;
  const fullHtml = `<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8">
<style>
body{font-family:'Segoe UI',sans-serif;max-width:900px;margin:2rem auto;padding:0 1.5rem;color:#1a2a3a;line-height:1.7}
h2{color:#0d9488;border-bottom:2px solid #e6f5f3;padding-bottom:.3rem;margin:1.2rem 0 .5rem}
h3{margin:.8rem 0 .3rem}
table{width:100%;border-collapse:collapse;font-size:.9rem;margin:.5rem 0}
th{background:#0d9488;color:#fff;padding:.5rem .7rem;text-align:left}
td{border:1px solid #e2e8f0;padding:.5rem .7rem;vertical-align:top}
tr:nth-child(even) td{background:#f8fffe}
.header-doc{background:linear-gradient(135deg,#0d9488,#0a7a70);color:#fff;border-radius:8px;padding:1.2rem 1.5rem;margin-bottom:1rem;text-align:center}
.header-doc h1{color:#fff;margin-bottom:.3rem}
.section-box{border-left:3px solid #0d9488;padding:.7rem 1rem;margin:.5rem 0;background:#f8fffe;border-radius:0 8px 8px 0}
.moment-inicio{background:#fff7ed;border-left-color:#f97316}
.moment-desarrollo{background:#f0fdf9;border-left-color:#0d9488}
.moment-cierre{background:#fdf4ff;border-left-color:#a855f7}
.tip-box{background:#fef9c3;border:1px solid #fde047;border-radius:8px;padding:.7rem 1rem;font-size:.9rem;margin:.5rem 0}
ul{padding-left:1.2rem} li{margin:.2rem 0}
@media print{body{margin:0}h2{page-break-after:avoid}}
</style>
<title>${doc.title}</title></head><body>
${doc.isHtml ? doc.content : '<pre>'+escapeHtml(doc.content)+'</pre>'}
</body></html>`;
  const blob = new Blob([fullHtml], {type:'text/html;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${doc.title.replace(/[^a-zA-Z0-9√°√©√≠√≥√∫√±√Å√â√ç√ì√ö√ë ]/g,'_')}.html`;
  a.click(); URL.revokeObjectURL(a.href);
}

function printDoc(id){
  const doc = docs.find(d=>d.id===id); if(!doc) return;
  const win = window.open('','_blank');
  win.document.write(`<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8">
<style>
body{font-family:'Segoe UI',sans-serif;max-width:900px;margin:1.5rem auto;padding:0 1.5rem;color:#1a2a3a;line-height:1.7;font-size:11pt}
h2{color:#0d9488;border-bottom:2px solid #e6f5f3;padding-bottom:.3rem;margin:1.2rem 0 .5rem;font-size:12pt}
table{width:100%;border-collapse:collapse;font-size:9pt;margin:.5rem 0}
th{background:#0d9488;color:#fff;padding:.4rem .6rem;text-align:left}
td{border:1px solid #e2e8f0;padding:.4rem .6rem;vertical-align:top}
tr:nth-child(even) td{background:#f8fffe}
.header-doc{background:#0d9488;color:#fff;padding:1rem 1.5rem;margin-bottom:1rem;text-align:center}
.header-doc h1{color:#fff;margin-bottom:.2rem;font-size:14pt}
.section-box{border-left:3px solid #0d9488;padding:.5rem 1rem;margin:.4rem 0;background:#f8fffe}
.moment-inicio{background:#fff7ed;border-left-color:#f97316}
.moment-desarrollo{background:#f0fdf9}
.moment-cierre{background:#fdf4ff;border-left-color:#a855f7}
.tip-box{background:#fef9c3;border:1px solid #fde047;padding:.5rem 1rem;font-size:9pt}
ul{padding-left:1rem} li{margin:.15rem 0}
</style></head><body>${doc.isHtml ? doc.content : '<pre>'+escapeHtml(doc.content)+'</pre>'}</body></html>`);
  win.document.close();
  win.focus();
  setTimeout(()=>win.print(), 400);
}

function copyDocContent(id){
  const doc = docs.find(d=>d.id===id); if(!doc) return;
  const text = doc.isHtml
    ? doc.content.replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim()
    : doc.content;
  navigator.clipboard.writeText(text).then(()=>alert('‚úÖ Texto copiado al portapapeles'));
}

function escapeHtml(t){
  if(!t) return '';
  return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// =============================================
// CHAT ASSISTANT (with Claude AI)
// =============================================
let chatHistory = [];

async function sendChat(){
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if(!text) return;
  const container = document.getElementById('chatMessages');
  chatHistory.push({role:'user', content: text});
  container.innerHTML += `<div class="chat-msg user"><div class="chat-avatar">üë§</div><div class="chat-bubble user-bubble">${escapeHtml(text)}</div></div>`;
  input.value = '';
  document.getElementById('chatSuggestions').style.display = 'none';
  container.innerHTML += `<div class="chat-msg ai" id="typing"><div class="chat-avatar">ü§ñ</div><div class="chat-bubble ai-bubble"><span class="loading"></span> Pensando...</div></div>`;
  container.scrollTop = container.scrollHeight;

  try {
    const chatApiKey = getApiKey();
    if(!chatApiKey){
      const typing = document.getElementById('typing');
      if(typing) typing.remove();
      container.innerHTML += `<div class="chat-msg ai"><div class="chat-avatar">ü§ñ</div><div class="chat-bubble ai-bubble">‚ö†Ô∏è Para usar el Asistente IA necesitas ingresar tu API Key. Haz clic en <strong>üîë Conectar API Key</strong> en la barra lateral.</div></div>`;
      container.scrollTop = container.scrollHeight;
      return;
    }
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'x-api-key': chatApiKey,
        'anthropic-version':'2023-06-01',
        'anthropic-dangerous-direct-browser-access':'true'
      },
      body: JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:1000,
        system:'Eres un asistente pedag√≥gico experto en el Curr√≠culo Nacional de Educaci√≥n B√°sica (CNEB) del MINEDU Per√∫ para nivel secundaria. Responde en espa√±ol, de forma clara, estructurada y pr√°ctica. Usa emojis pedag√≥gicos (üìåüìéüìã‚úÖ) para organizar la respuesta. Usa **negrita** para t√©rminos clave. Proporciona ejemplos concretos del contexto peruano. M√°ximo 400 palabras por respuesta.',
        messages: chatHistory
      })
    });
    if(!response.ok){
      const err = await response.json().catch(()=>({}));
      throw new Error(err.error?.message || 'Error de red');
    }
    const data = await response.json();
    const reply = data.content ? data.content.map(b=>b.text||'').join('') : 'Lo siento, no pude procesar tu consulta.';
    chatHistory.push({role:'assistant', content: reply});
    const typing = document.getElementById('typing');
    if(typing) typing.remove();
    container.innerHTML += `<div class="chat-msg ai"><div class="chat-avatar">ü§ñ</div><div class="chat-bubble ai-bubble">${reply.replace(/\n/g,'<br>').replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')}</div></div>`;
  } catch(e){
    const typing = document.getElementById('typing');
    if(typing) typing.remove();
    container.innerHTML += `<div class="chat-msg ai"><div class="chat-avatar">ü§ñ</div><div class="chat-bubble ai-bubble">‚ùå Error de conexi√≥n. Verifica tu red e intenta de nuevo.</div></div>`;
  }
  container.scrollTop = container.scrollHeight;
}

function useSuggestion(btn){
  document.getElementById('chatInput').value = btn.textContent;
  sendChat();
}
</script>
<script>updateApiKeyBadge();</script>
</body>
</html>
