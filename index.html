<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Neurosim ‚Äì Planificador de Clases CNEB</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#faf9f6;--fg:#1a2a3a;--card:#fff;--primary:#0d9488;--primary-fg:#fff;
  --secondary:#e6f5f3;--sec-fg:#0a7a70;--muted:#94a3b8;--accent:#e8920d;
  --border:#e2e8f0;--radius:12px;--shadow:0 2px 12px rgba(0,0,0,.08);
  --font:'Segoe UI',system-ui,-apple-system,sans-serif;
}
body{font-family:var(--font);background:var(--bg);color:var(--fg);line-height:1.6}
a{color:var(--primary);text-decoration:none}
button{cursor:pointer;font-family:inherit}
input,select,textarea{font-family:inherit;font-size:.95rem}

/* Auth */
.auth-page{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1rem;position:relative;overflow:hidden}
.auth-page::before{content:'';position:absolute;top:-120px;right:-120px;width:380px;height:380px;border-radius:50%;background:rgba(13,148,136,.06);filter:blur(60px)}
.auth-page::after{content:'';position:absolute;bottom:-120px;left:-120px;width:380px;height:380px;border-radius:50%;background:rgba(232,146,13,.08);filter:blur(60px)}
.auth-box{width:100%;max-width:400px;z-index:1;text-align:center}
.auth-logo{width:56px;height:56px;border-radius:16px;background:var(--primary);display:inline-flex;align-items:center;justify-content:center;color:#fff;font-size:1.6rem;font-weight:800;margin-bottom:.5rem}
.auth-box h1{font-size:2rem;font-weight:800;margin-bottom:.15rem}
.auth-box .subtitle{color:var(--primary);font-weight:600;font-size:.9rem}
.auth-box .desc{color:var(--muted);font-size:.85rem;margin:.5rem 0 2rem}
.auth-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:2rem;box-shadow:var(--shadow);text-align:left}
.auth-card h2{font-size:1.2rem;font-weight:700;margin-bottom:1.2rem;display:flex;align-items:center;gap:.5rem}
.form-group{margin-bottom:1rem}
.form-group label{display:block;font-size:.8rem;font-weight:600;margin-bottom:.3rem;color:var(--fg)}
.form-group input{width:100%;padding:.6rem .8rem;border:1px solid var(--border);border-radius:8px;outline:none;transition:border .2s}
.form-group input:focus{border-color:var(--primary)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:.4rem;padding:.65rem 1.5rem;border:none;border-radius:8px;font-weight:600;font-size:.9rem;transition:all .2s}
.btn-primary{background:var(--primary);color:var(--primary-fg);width:100%}
.btn-primary:hover{opacity:.9}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--fg);width:100%}
.btn-outline:hover{background:var(--secondary)}
.btn-sm{padding:.45rem 1rem;font-size:.8rem}
.link-btn{background:none;border:none;color:var(--primary);font-size:.8rem;font-weight:500}
.link-btn:hover{text-decoration:underline}
.divider{display:flex;align-items:center;gap:.8rem;margin:1rem 0;color:var(--muted);font-size:.75rem;text-transform:uppercase}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border)}

/* Layout */
.app{display:flex;min-height:100vh}
.sidebar{width:240px;background:#1a2a3a;color:#c8d6e5;display:flex;flex-direction:column;padding:1rem 0;position:fixed;top:0;left:0;bottom:0;z-index:50;transition:transform .3s}
.sidebar .logo{display:flex;align-items:center;gap:.6rem;padding:0 1.2rem;margin-bottom:1.5rem}
.sidebar .logo-icon{width:36px;height:36px;border-radius:10px;background:var(--primary);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:1rem}
.sidebar .logo span{font-weight:700;font-size:1.1rem;color:#fff}
.sidebar nav{flex:1}
.sidebar nav a,.sidebar nav button{display:flex;align-items:center;gap:.7rem;padding:.6rem 1.2rem;color:#a0b4c8;font-size:.85rem;font-weight:500;border:none;background:none;width:100%;text-align:left;border-radius:0;transition:all .15s}
.sidebar nav a:hover,.sidebar nav button:hover{background:rgba(255,255,255,.06);color:#fff}
.sidebar nav a.active{background:rgba(13,148,136,.15);color:#5eead4;border-right:3px solid var(--primary)}
.main{flex:1;margin-left:240px;padding:1.5rem 2rem;max-width:960px}
.main h1{font-size:1.6rem;font-weight:800;margin-bottom:.3rem}
.main .page-desc{color:var(--muted);font-size:.9rem;margin-bottom:1.5rem}

/* Cards & Stats */
.quick-actions{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:.6rem;margin-bottom:2rem}
.qa-btn{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem .8rem;text-align:center;font-size:.8rem;font-weight:600;color:var(--fg);transition:all .15s;box-shadow:var(--shadow)}
.qa-btn:hover{border-color:var(--primary);background:var(--secondary)}
.qa-btn .icon{font-size:1.4rem;margin-bottom:.3rem}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem;box-shadow:var(--shadow);margin-bottom:.8rem}
.card h3{font-size:.95rem;font-weight:700;margin-bottom:.6rem}

/* Forms & Files */
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:.8rem}
@media(max-width:600px){.form-row{grid-template-columns:1fr}}
.form-group select{width:100%;padding:.6rem .8rem;border:1px solid var(--border);border-radius:8px;outline:none;background:#fff}
.form-group select:focus{border-color:var(--primary)}
.form-group textarea{width:100%;padding:.6rem .8rem;border:1px solid var(--border);border-radius:8px;outline:none;resize:vertical;min-height:80px}
.form-group textarea:focus{border-color:var(--primary)}
.file-drop{border:2px dashed var(--border);border-radius:var(--radius);padding:1.5rem;text-align:center;color:var(--muted);font-size:.85rem;cursor:pointer;transition:border .2s;margin-top:.5rem;background:#faf9f6}
.file-drop:hover{border-color:var(--primary);background:var(--secondary);color:var(--sec-fg)}
.file-drop input{display:none}
.file-name-label{display:none;color:var(--primary);font-size:0.8rem;font-weight:600;margin-top:0.4rem;text-align:center}

/* CNEB info panel & Dynamic areas */
.cneb-panel{background:linear-gradient(135deg,#f0fdf9,#e6f5f3);border:1px solid #a7f3d0;border-radius:var(--radius);padding:1rem;margin-bottom:1rem;font-size:.82rem}
.cneb-panel .cneb-title{font-weight:700;color:var(--primary);margin-bottom:.4rem;font-size:.85rem}
.cneb-tag{display:inline-block;background:var(--primary);color:#fff;border-radius:20px;padding:.15rem .6rem;font-size:.72rem;font-weight:600;margin:.15rem .1rem;cursor:pointer;transition:opacity .15s}
.cneb-tag:hover{opacity:.8}

.checkbox-list label {display:flex; align-items:flex-start; gap:0.5rem; font-size:0.85rem; margin-bottom:0.4rem; font-weight:normal;}
.checkbox-list input {margin-top:0.2rem;}
.desempenos-box {background:#f8fffe; border:1px solid var(--border); border-radius:8px; padding:0.8rem; font-size:0.85rem; color:var(--muted); margin-top:0.4rem;}

/* Output - rendered HTML */
.output-rendered{background:#fff;border:1px solid #a7f3d0;border-radius:var(--radius);padding:1.5rem 2rem;margin-top:1rem;font-size:.9rem;line-height:1.8;max-height:600px;overflow-y:auto}
.output-rendered h2{color:var(--primary);font-size:1rem;font-weight:700;border-bottom:2px solid var(--secondary);padding-bottom:.3rem;margin:1.2rem 0 .5rem}
.output-rendered h3{color:var(--fg);font-size:.9rem;font-weight:700;margin:.8rem 0 .3rem}
.output-rendered table{width:100%;border-collapse:collapse;font-size:.82rem;margin:.5rem 0}
.output-rendered th{background:var(--primary);color:#fff;padding:.5rem .7rem;text-align:left;font-weight:600}
.output-rendered td{border:1px solid var(--border);padding:.5rem .7rem;vertical-align:top}

/* Loading */
.loading{display:inline-block;width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.gen-loading{display:flex;align-items:center;gap:.8rem;padding:1.5rem;background:var(--secondary);border-radius:var(--radius);font-size:.9rem;color:var(--sec-fg);font-weight:600;margin-top:1rem}

/* Chat */
.chat-msg{display:flex;gap:.5rem;align-items:flex-start; margin-bottom: 0.8rem;}
.chat-msg.user{flex-direction:row-reverse}
.chat-avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0}
.chat-msg.ai .chat-avatar{background:var(--primary);color:#fff}
.chat-msg.user .chat-avatar{background:var(--accent);color:#fff}
.chat-bubble{max-width:80%;padding:.6rem 1rem;border-radius:16px;font-size:.85rem;line-height:1.6}
.ai-bubble{background:var(--secondary);color:var(--fg);border-bottom-left-radius:4px}
.user-bubble{background:var(--primary);color:#fff;border-bottom-right-radius:4px}

/* Mobile */
.menu-toggle{display:none;position:fixed;top:.8rem;left:.8rem;z-index:60;background:var(--primary);color:#fff;border:none;border-radius:8px;width:40px;height:40px;font-size:1.2rem}
@media(max-width:768px){
  .sidebar{transform:translateX(-100%)}
  .sidebar.open{transform:translateX(0)}
  .main{margin-left:0;padding:1rem}
  .menu-toggle{display:flex;align-items:center;justify-content:center}
}
.hidden{display:none!important}
</style>
</head>
<body>

<div id="authPage" class="auth-page">
  <div class="auth-box">
    <div class="auth-logo">N</div>
    <h1>Neurosim</h1>
    <p class="subtitle">Planificador de Clases ‚Äì CNEB</p>
    <div class="auth-card">
      <button class="btn btn-primary" onclick="enterApp()">Acceder a la plataforma ‚Üí</button>
    </div>
  </div>
</div>

<div id="appShell" class="app hidden">
  <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>

  <aside class="sidebar" id="sidebar">
    <div class="logo"><div class="logo-icon">N</div><span>Neurosim</span></div>
    <nav>
      <a href="#" id="nav-dashboard" class="active" onclick="showPage('dashboard',this)">üìä Dashboard</a>
      <a href="#" id="nav-sesion" onclick="showPage('sesion',this)">üìù Sesi√≥n de Aprendizaje</a>
      <a href="#" id="nav-unidad" onclick="showPage('unidad',this)">üìö Unidad Did√°ctica</a>
      <a href="#" id="nav-planificacion" onclick="showPage('planificacion',this)">üìÖ Planificaci√≥n Anual</a>
      <a href="#" id="nav-asistente" onclick="showPage('asistente',this)">ü§ñ Asistente IA</a>
      <button onclick="logout()" style="margin-top:auto;color:#f87171">üö™ Cerrar sesi√≥n</button>
    </nav>
  </aside>

  <div class="main">
    <div id="page-dashboard">
      <h1>¬°Bienvenido, Docente! üëã</h1>
      <p class="page-desc">Panel de planificaci√≥n pedag√≥gica ‚Äì CNEB Secundaria</p>
      <div class="quick-actions">
        <button class="qa-btn" onclick="showPage('sesion',document.getElementById('nav-sesion'))"><div class="icon">üìù</div>Nueva Sesi√≥n</button>
        <button class="qa-btn" onclick="showPage('unidad',document.getElementById('nav-unidad'))"><div class="icon">üìö</div>Nueva Unidad</button>
        <button class="qa-btn" onclick="showPage('planificacion',document.getElementById('nav-planificacion'))"><div class="icon">üìÖ</div>Plan Anual</button>
      </div>
    </div>

    <div id="page-sesion" class="hidden">
      <h1>üìù Sesi√≥n de Aprendizaje</h1>
      <div class="card">
        <h3>Datos de la sesi√≥n</h3>
        
        <div class="form-group">
          <label>Plantilla o Formato Base (Admite .txt y .docx)</label>
          <div class="file-drop" onclick="document.getElementById('sesFile').click()">
            üìÑ Haz clic para subir tu formato base (.txt o Word .docx)
            <input type="file" id="sesFile" accept=".txt, .doc, .docx" onchange="showFileName(this, 'sesFileName')">
          </div>
          <div id="sesFileName" class="file-name-label"></div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>√Årea Curricular</label>
            <select id="sesArea" onchange="onAreaChange('ses')">
              <option>Comunicaci√≥n</option><option>Matem√°tica</option><option>Ciencia y Tecnolog√≠a</option>
            </select>
          </div>
        </div>
        <div id="sesCnebPanel" class="cneb-panel"><div class="cneb-title">üìã Competencias CNEB (haz clic)</div><div id="sesCnebCompetencias"></div></div>
        
        <div class="form-group"><label>T√≠tulo de la sesi√≥n</label><input id="sesTitulo" placeholder="Ej: Analizamos textos argumentativos"></div>
        <div class="form-group"><label>Competencia seleccionada</label><select id="sesCompetencia" onchange="onCompetenciaChange('ses')"><option value="">-- Selecciona --</option></select></div>
        
        <div class="form-group">
          <label>Capacidades (Marca las que usar√°s)</label>
          <div id="sesCapacidades" class="checkbox-list">Selecciona una competencia arriba.</div>
        </div>
        
        <div class="form-group">
          <label>Desempe√±os espec√≠ficos (Se actualizan seg√∫n las capacidades)</label>
          <div id="sesDesempenos" class="desempenos-box checkbox-list">Selecciona capacidades para ver los desempe√±os.</div>
        </div>
        
        <button class="btn btn-primary" id="btnGenSes" onclick="generarSesionIA()" style="width:auto;margin-top:1rem">‚ú® Generar Sesi√≥n con IA</button>
      </div>
      <div id="sesOutput"></div>
    </div>

    <div id="page-unidad" class="hidden">
      <h1>üìö Unidad Did√°ctica</h1>
      <div class="card">
        <div class="form-group">
          <label>Plantilla o Formato Base (Admite .txt y .docx)</label>
          <div class="file-drop" onclick="document.getElementById('uniFile').click()">
            üìÑ Haz clic para subir tu formato base (.txt o Word .docx)
            <input type="file" id="uniFile" accept=".txt, .doc, .docx" onchange="showFileName(this, 'uniFileName')">
          </div>
          <div id="uniFileName" class="file-name-label"></div>
        </div>

        <div class="form-group"><label>√Årea Curricular</label><select id="uniArea" onchange="onAreaChange('uni')"><option>Comunicaci√≥n</option><option>Matem√°tica</option><option>Ciencia y Tecnolog√≠a</option></select></div>
        <div id="uniCnebPanel" class="cneb-panel"><div class="cneb-title">üìã Competencias CNEB</div><div id="uniCnebCompetencias"></div></div>
        <div class="form-group"><label>T√≠tulo de la Unidad</label><input id="uniTitulo" placeholder="Ej: Comprendemos textos"></div>
        <div class="form-group"><label>Competencias a trabajar</label><textarea id="uniCompetencias" style="min-height:70px"></textarea></div>
        
        <button class="btn btn-primary" onclick="generarUnidadIA()" style="width:auto;margin-top:1rem">‚ú® Generar Unidad con IA</button>
      </div>
      <div id="uniOutput"></div>
    </div>

    <div id="page-planificacion" class="hidden">
      <h1>üìÖ Planificaci√≥n Anual</h1>
      <div class="card">
        <div class="form-group">
          <label>Plantilla o Formato Base (Admite .txt y .docx)</label>
          <div class="file-drop" onclick="document.getElementById('planFile').click()">
            üìÑ Haz clic para subir tu formato base (.txt o Word .docx)
            <input type="file" id="planFile" accept=".txt, .doc, .docx" onchange="showFileName(this, 'planFileName')">
          </div>
          <div id="planFileName" class="file-name-label"></div>
        </div>

        <div class="form-group"><label>√Årea Curricular</label><select id="planArea" onchange="onAreaChange('plan')"><option>Comunicaci√≥n</option><option>Matem√°tica</option><option>Ciencia y Tecnolog√≠a</option></select></div>
        <div id="planCnebPanel" class="cneb-panel"><div class="cneb-title">üìã Competencias CNEB</div><div id="planCnebCompetencias"></div></div>
        <div class="form-group"><label>Competencias del √°rea</label><textarea id="planCompetencias" style="min-height:70px"></textarea></div>
        
        <button class="btn btn-primary" onclick="generarPlanAnualIA()" style="width:auto;margin-top:1rem">‚ú® Generar Planificaci√≥n con IA</button>
      </div>
      <div id="planOutput"></div>
    </div>

    <div id="page-asistente" class="hidden">
      <h1>ü§ñ Asistente Pedag√≥gico IA</h1>
      <div class="card" style="display:flex;flex-direction:column;height:calc(100vh - 12rem);padding:0;overflow:hidden">
        <div id="chatMessages" style="flex:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;">
          <div class="chat-msg ai"><div class="chat-avatar">ü§ñ</div><div class="chat-bubble ai-bubble">¬°Hola! Soy tu asistente. ¬øEn qu√© te ayudo?</div></div>
        </div>
        <div style="padding:.8rem 1rem;border-top:1px solid var(--border);display:flex;gap:.5rem">
          <input id="chatInput" placeholder="Escribe tu pregunta..." style="flex:1;padding:.6rem .8rem;border:1px solid var(--border);border-radius:8px;outline:none" onkeydown="if(event.key==='Enter')sendChat()">
          <button class="btn btn-primary" onclick="sendChat()" style="width:auto;padding:.6rem 1rem">üì§ Enviar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Base de datos de Competencias, Capacidades y Desempe√±os
const areasCNEB = {
  "Comunicaci√≥n": [
    { 
      name: "Se comunica oralmente", 
      caps: [
        { name: "Obtiene informaci√≥n del texto oral", des: ["Recupera informaci√≥n expl√≠cita de los textos orales que escucha.", "Selecciona datos espec√≠ficos e integra esta informaci√≥n."] },
        { name: "Infiere e interpreta informaci√≥n", des: ["Deduce diversas relaciones l√≥gicas entre las ideas del texto oral.", "Explica el tema y el prop√≥sito comunicativo del texto."] }
      ] 
    },
    { 
      name: "Lee diversos tipos de textos", 
      caps: [
        { name: "Obtiene informaci√≥n del texto escrito", des: ["Identifica informaci√≥n expl√≠cita, relevante y complementaria.", "Integra informaci√≥n expl√≠cita cuando se encuentra en distintas partes del texto."] },
        { name: "Infiere e interpreta del texto", des: ["Deduce caracter√≠sticas impl√≠citas de seres, objetos, hechos y lugares.", "Explica el tema, los subtemas y el prop√≥sito comunicativo del texto."] }
      ] 
    },
    { 
      name: "Escribe diversos tipos de textos", 
      caps: [
        { name: "Adec√∫a el texto a la situaci√≥n", des: ["Adec√∫a el texto a la situaci√≥n comunicativa considerando el prop√≥sito y el destinatario.", "Elige estrat√©gicamente el registro formal o informal."] },
        { name: "Organiza y desarrolla las ideas", des: ["Escribe textos de forma coherente y cohesionada.", "Ordena las ideas en torno a un tema, las jerarquiza en subtemas."] }
      ] 
    }
  ],
  "Matem√°tica": [
    { 
      name: "Resuelve problemas de cantidad", 
      caps: [
        { name: "Traduce cantidades a expresiones", des: ["Establece relaciones entre datos y acciones de agregar, quitar, igualar.", "Expresa con diversas representaciones y lenguaje num√©rico su comprensi√≥n."] },
        { name: "Comunica su comprensi√≥n", des: ["Expresa el significado de los n√∫meros racionales y sus operaciones.", "Justifica sus procedimientos matem√°ticos usando propiedades."] }
      ] 
    },
    { 
      name: "Resuelve problemas de regularidad", 
      caps: [
        { name: "Traduce datos y condiciones", des: ["Establece relaciones entre datos y valores desconocidos.", "Transforma relaciones a expresiones algebraicas que incluyen ecuaciones."] },
        { name: "Comunica comprensi√≥n algebraica", des: ["Expresa su comprensi√≥n de la relaci√≥n entre funci√≥n lineal y sus representaciones gr√°ficas."] }
      ] 
    }
  ],
  "Ciencia y Tecnolog√≠a": [
    { 
      name: "Indaga mediante m√©todos cient√≠ficos", 
      caps: [
        { name: "Problematiza situaciones", des: ["Formula preguntas sobre las variables que influyen en un hecho.", "Plantea hip√≥tesis basadas en conocimientos cient√≠ficos."] },
        { name: "Dise√±a estrategias", des: ["Propone procedimientos para observar, manipular la variable independiente y medir la dependiente.", "Selecciona herramientas, materiales e instrumentos para recoger datos."] }
      ] 
    }
  ]
};

function enterApp() {
  document.getElementById('authPage').classList.add('hidden');
  document.getElementById('appShell').classList.remove('hidden');
  onAreaChange('ses'); onAreaChange('uni'); onAreaChange('plan');
}

function logout() {
  document.getElementById('appShell').classList.add('hidden');
  document.getElementById('authPage').classList.remove('hidden');
}

function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

function showPage(pageId, navEl) {
  document.querySelectorAll('.main > div').forEach(el => el.classList.add('hidden'));
  document.getElementById('page-' + pageId).classList.remove('hidden');
  document.querySelectorAll('.sidebar nav a').forEach(el => el.classList.remove('active'));
  if (navEl) navEl.classList.add('active');
  if (window.innerWidth <= 768) toggleSidebar();
}

function onAreaChange(prefix) {
  const area = document.getElementById(prefix + 'Area').value;
  const comps = areasCNEB[area] || [];
  if (prefix === 'ses') {
    const sel = document.getElementById('sesCompetencia');
    sel.innerHTML = '<option value="">-- Selecciona --</option>';
    comps.forEach((c, i) => { sel.innerHTML += `<option value="${i}">${c.name}</option>`; });
    document.getElementById('sesCnebCompetencias').innerHTML = comps.map((c, i) => `<span class="cneb-tag" onclick="selectCompetencia(${i})">${c.name}</span>`).join('');
    document.getElementById('sesCapacidades').innerHTML = "Selecciona una competencia arriba.";
    document.getElementById('sesDesempenos').innerHTML = "Selecciona capacidades para ver los desempe√±os.";
  } else if (prefix === 'uni') {
    document.getElementById('uniCnebCompetencias').innerHTML = comps.map(c => `<span class="cneb-tag" onclick="addCompetenciaToTextarea('uniCompetencias', '${c.name}')">${c.name}</span>`).join('');
  } else if (prefix === 'plan') {
    document.getElementById('planCnebCompetencias').innerHTML = comps.map(c => `<span class="cneb-tag" onclick="addCompetenciaToTextarea('planCompetencias', '${c.name}')">${c.name}</span>`).join('');
  }
}

function selectCompetencia(index) {
  document.getElementById('sesCompetencia').value = index;
  onCompetenciaChange('ses');
}

function addCompetenciaToTextarea(id, compName) {
  const ta = document.getElementById(id);
  ta.value = ta.value ? ta.value + '\n- ' + compName : '- ' + compName;
}

// Actualizar Capacidades
function onCompetenciaChange(prefix) {
  const area = document.getElementById(prefix + 'Area').value;
  const compIdx = document.getElementById(prefix + 'Competencia').value;
  
  const capContainer = document.getElementById(prefix + 'Capacidades');
  const desContainer = document.getElementById(prefix + 'Desempenos');
  
  if (compIdx === '') {
    capContainer.innerHTML = 'Selecciona una competencia arriba.';
    desContainer.innerHTML = 'Selecciona capacidades para ver los desempe√±os.';
    return;
  }
  
  const caps = areasCNEB[area][compIdx].caps;
  
  // Renderizar checkboxes de capacidades
  capContainer.innerHTML = caps.map((cap, capIdx) => 
    `<label><input type="checkbox" class="chk-capacidad" value="${capIdx}" onchange="updateDesempenos('${prefix}')" checked> ${cap.name}</label>`
  ).join('');
  
  // Cargar desempe√±os iniciales
  updateDesempenos(prefix);
}

// Actualizar Desempe√±os din√°micamente seg√∫n las capacidades marcadas
function updateDesempenos(prefix) {
  const area = document.getElementById(prefix + 'Area').value;
  const compIdx = document.getElementById(prefix + 'Competencia').value;
  const desContainer = document.getElementById(prefix + 'Desempenos');
  
  const checkboxes = document.querySelectorAll('#' + prefix + 'Capacidades .chk-capacidad');
  let html = '';
  let haySeleccion = false;

  checkboxes.forEach(chk => {
    if (chk.checked) {
      haySeleccion = true;
      const capIdx = chk.value;
      const capacidad = areasCNEB[area][compIdx].caps[capIdx];
      
      html += `<div style="margin-bottom:0.8rem;">
                 <strong style="color:var(--primary);display:block;margin-bottom:0.3rem;">De: ${capacidad.name}</strong>`;
      capacidad.des.forEach(des => {
        html += `<label><input type="checkbox" class="chk-desempeno" value="${des}" checked> ${des}</label>`;
      });
      html += `</div>`;
    }
  });

  desContainer.innerHTML = haySeleccion ? html : 'No hay capacidades seleccionadas.';
}

// ====== LOGICA PARA LEER ARCHIVOS (TXT y WORD/DOCX) ======
function showFileName(input, labelId) {
  const label = document.getElementById(labelId);
  if (input.files && input.files.length > 0) {
    label.textContent = "‚úÖ Archivo cargado: " + input.files[0].name;
    label.style.display = "block";
  } else {
    label.style.display = "none";
  }
}

async function readFileText(inputId) {
  const input = document.getElementById(inputId);
  if (!input || !input.files || input.files.length === 0) return "";
  const file = input.files[0];
  const extension = file.name.split('.').pop().toLowerCase();

  return new Promise((resolve, reject) => {
    if (extension === 'txt') {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.onerror = e => reject(e);
      reader.readAsText(file);
    } 
    else if (extension === 'docx' || extension === 'doc') {
      const reader = new FileReader();
      reader.onload = function(event) {
        const arrayBuffer = event.target.result;
        // Mammoth.js extrae el texto puro del documento Word
        mammoth.extractRawText({arrayBuffer: arrayBuffer})
          .then(result => resolve(result.value))
          .catch(err => {
            console.error("Error leyendo Word:", err);
            reject("No se pudo leer el archivo Word. Aseg√∫rate de que sea .docx");
          });
      };
      reader.readAsArrayBuffer(file);
    } else {
      resolve("");
    }
  });
}

// ====== LLAMADAS A LA IA ======
async function callIA(prompt, outputId) {
  const output = document.getElementById(outputId);
  output.innerHTML = '<div class="gen-loading"><div class="loading"></div>Generando contenido pedag√≥gico...</div>';
  try {
    const res = await fetch('/api/generar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt })
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    output.innerHTML = `<div class="output-rendered">${data.respuesta}</div>`;
  } catch (err) {
    output.innerHTML = `<div class="cneb-panel" style="border-color: red; color: red;">‚ùå Error al conectar con la Inteligencia Artificial.</div>`;
  }
}

// CONSTRUCCI√ìN DIN√ÅMICA DE PROMPTS
async function generarSesionIA() {
  const area = document.getElementById('sesArea').value;
  const titulo = document.getElementById('sesTitulo').value || "Tema propuesto por la IA";
  const compSelect = document.getElementById('sesCompetencia');
  const competencia = compSelect.options[compSelect.selectedIndex]?.text || "No especificada";
  
  // Recoger capacidades seleccionadas
  const capNodes = document.querySelectorAll('#sesCapacidades .chk-capacidad:checked');
  const capacidades = Array.from(capNodes).map(n => n.parentNode.textContent.trim()).join(", ");
  
  // Recoger desempe√±os seleccionados
  const desNodes = document.querySelectorAll('#sesDesempenos .chk-desempeno:checked');
  const desempenos = Array.from(desNodes).map(n => n.value).join(" | ");

  // Leer plantilla (txt o word)
  let templateText = await readFileText('sesFile');
  let formatInstruccion = templateText ? `\n\n=== REGLA ESTRICTA ===\nUtiliza la siguiente estructura y esquema como plantilla para tu respuesta, llenando los campos correspondientes:\n\n${templateText}` : "";
  
  const prompt = `Act√∫a como un experto pedag√≥gico del MINEDU Per√∫. Desarrolla una Sesi√≥n de Aprendizaje CNEB.
Datos de la sesi√≥n:
- √Årea: ${area}
- Tema: ${titulo}
- Competencia: ${competencia}
- Capacidades a movilizar: ${capacidades || 'A sugerencia de la IA'}
- Desempe√±os precisados: ${desempenos || 'A sugerencia de la IA'}
${formatInstruccion}`;

  await callIA(prompt, 'sesOutput');
}

async function generarUnidadIA() {
  const area = document.getElementById('uniArea').value;
  const titulo = document.getElementById('uniTitulo').value || "Unidad Did√°ctica";
  const competencias = document.getElementById('uniCompetencias').value;
  
  let templateText = await readFileText('uniFile');
  let formatInstruccion = templateText ? `\n\n=== REGLA ESTRICTA ===\nUtiliza la siguiente estructura y esquema como plantilla para tu respuesta:\n\n${templateText}` : "";
  
  const prompt = `Act√∫a como experto MINEDU. Desarrolla una Unidad Did√°ctica CNEB.
- √Årea: ${area}
- T√≠tulo/Situaci√≥n Significativa: ${titulo}
- Competencias: ${competencias}
${formatInstruccion}`;
  
  await callIA(prompt, 'uniOutput');
}

async function generarPlanAnualIA() {
  const area = document.getElementById('planArea').value;
  const competencias = document.getElementById('planCompetencias').value;
  
  let templateText = await readFileText('planFile');
  let formatInstruccion = templateText ? `\n\n=== REGLA ESTRICTA ===\nUtiliza la siguiente estructura y esquema como plantilla para tu respuesta:\n\n${templateText}` : "";
  
  const prompt = `Act√∫a como experto MINEDU. Desarrolla un Plan Anual CNEB.
- √Årea: ${area}
- Competencias a priorizar: ${competencias}
${formatInstruccion}`;
  
  await callIA(prompt, 'planOutput');
}

async function sendChat() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;
  const container = document.getElementById('chatMessages');
  container.innerHTML += `<div class="chat-msg user"><div class="chat-avatar">üë§</div><div class="chat-bubble user-bubble">${text}</div></div>`;
  input.value = '';
  container.innerHTML += `<div id="typing" class="chat-msg ai"><div class="chat-avatar">ü§ñ</div><div class="chat-bubble ai-bubble"><div class="loading" style="width:12px;height:12px;border-width:1.5px"></div></div></div>`;
  container.scrollTop = container.scrollHeight;

  try {
    const res = await fetch('/api/generar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt: `Act√∫a como Experto CNEB. Responde a esto: ${text}` })
    });
    const data = await res.json();
    document.getElementById('typing').remove();
    container.innerHTML += `<div class="chat-msg ai"><div class="chat-avatar">ü§ñ</div><div class="chat-bubble ai-bubble">${data.respuesta}</div></div>`;
  } catch (err) {
    document.getElementById('typing').remove();
  }
  container.scrollTop = container.scrollHeight;
}
</script>
</body>
</html>
