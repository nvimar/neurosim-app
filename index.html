<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Neurosim ‚Äì Planificador de Clases CNEB</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#faf9f6;--fg:#1a2a3a;--card:#fff;--primary:#0d9488;--primary-fg:#fff;
  --secondary:#e6f5f3;--sec-fg:#0a7a70;--muted:#94a3b8;--accent:#e8920d;
  --border:#e2e8f0;--radius:12px;--shadow:0 2px 12px rgba(0,0,0,.08);
  --font:'Segoe UI',system-ui,-apple-system,sans-serif;
}
body{font-family:var(--font);background:var(--bg);color:var(--fg);line-height:1.6}
a{color:var(--primary);text-decoration:none}
button{cursor:pointer;font-family:inherit}
input,select,textarea{font-family:inherit;font-size:.95rem}

/* Auth */
.auth-page{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1rem;position:relative;overflow:hidden}
.auth-page::before{content:'';position:absolute;top:-120px;right:-120px;width:380px;height:380px;border-radius:50%;background:rgba(13,148,136,.06);filter:blur(60px)}
.auth-page::after{content:'';position:absolute;bottom:-120px;left:-120px;width:380px;height:380px;border-radius:50%;background:rgba(232,146,13,.08);filter:blur(60px)}
.auth-box{width:100%;max-width:400px;z-index:1;text-align:center}
.auth-logo{width:56px;height:56px;border-radius:16px;background:var(--primary);display:inline-flex;align-items:center;justify-content:center;color:#fff;font-size:1.6rem;font-weight:800;margin-bottom:.5rem}
.auth-box h1{font-size:2rem;font-weight:800;margin-bottom:.15rem}
.auth-box .subtitle{color:var(--primary);font-weight:600;font-size:.9rem}
.auth-box .desc{color:var(--muted);font-size:.85rem;margin:.5rem 0 2rem}
.auth-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:2rem;box-shadow:var(--shadow);text-align:left}
.auth-card h2{font-size:1.2rem;font-weight:700;margin-bottom:1.2rem;display:flex;align-items:center;gap:.5rem}
.form-group{margin-bottom:1rem}
.form-group label{display:block;font-size:.8rem;font-weight:600;margin-bottom:.3rem;color:var(--fg)}
.form-group input{width:100%;padding:.6rem .8rem;border:1px solid var(--border);border-radius:8px;outline:none;transition:border .2s}
.form-group input:focus{border-color:var(--primary)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:.4rem;padding:.65rem 1.5rem;border:none;border-radius:8px;font-weight:600;font-size:.9rem;transition:all .2s}
.btn-primary{background:var(--primary);color:var(--primary-fg);width:100%}
.btn-primary:hover{opacity:.9}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--fg);width:100%}
.btn-outline:hover{background:var(--secondary)}
.btn-success{background:#10b981;color:#fff;width:auto;margin-top:1rem;display:none}
.btn-success:hover{background:#059669}
.divider{display:flex;align-items:center;gap:.8rem;margin:1rem 0;color:var(--muted);font-size:.75rem;text-transform:uppercase}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border)}

/* Layout */
.app{display:flex;min-height:100vh}
.sidebar{width:240px;background:#1a2a3a;color:#c8d6e5;display:flex;flex-direction:column;padding:1rem 0;position:fixed;top:0;left:0;bottom:0;z-index:50;transition:transform .3s}
.sidebar .logo{display:flex;align-items:center;gap:.6rem;padding:0 1.2rem;margin-bottom:1.5rem}
.sidebar .logo-icon{width:36px;height:36px;border-radius:10px;background:var(--primary);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:1rem}
.sidebar .logo span{font-weight:700;font-size:1.1rem;color:#fff}
.sidebar nav{flex:1}
.sidebar nav a,.sidebar nav button{display:flex;align-items:center;gap:.7rem;padding:.6rem 1.2rem;color:#a0b4c8;font-size:.85rem;font-weight:500;border:none;background:none;width:100%;text-align:left;border-radius:0;transition:all .15s}
.sidebar nav a:hover,.sidebar nav button:hover{background:rgba(255,255,255,.06);color:#fff}
.sidebar nav a.active{background:rgba(13,148,136,.15);color:#5eead4;border-right:3px solid var(--primary)}
.sidebar .user-area{padding:.8rem 1.2rem;border-top:1px solid rgba(255,255,255,.08);font-size:.8rem;color:#7a8fa0}
.main{flex:1;margin-left:240px;padding:1.5rem 2rem;max-width:960px}
.main h1{font-size:1.6rem;font-weight:800;margin-bottom:.3rem}
.main .page-desc{color:var(--muted);font-size:.9rem;margin-bottom:1.5rem}

/* Cards & Stats */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.8rem;margin-bottom:1.5rem}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1rem;display:flex;align-items:center;gap:.8rem;box-shadow:var(--shadow)}
.stat-icon{width:40px;height:40px;border-radius:10px;background:var(--secondary);display:flex;align-items:center;justify-content:center;color:var(--primary);font-size:1.1rem}
.stat-card .val{font-size:1.4rem;font-weight:800}
.stat-card .lbl{font-size:.72rem;color:var(--muted)}
.quick-actions{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:.6rem;margin-bottom:2rem}
.qa-btn{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem .8rem;text-align:center;font-size:.8rem;font-weight:600;color:var(--fg);transition:all .15s;box-shadow:var(--shadow)}
.qa-btn:hover{border-color:var(--primary);background:var(--secondary)}
.qa-btn .icon{font-size:1.4rem;margin-bottom:.3rem}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem;box-shadow:var(--shadow);margin-bottom:.8rem}
.card h3{font-size:.95rem;font-weight:700;margin-bottom:.6rem}

/* Forms & Files */
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:.8rem}
@media(max-width:600px){.form-row{grid-template-columns:1fr}}
.form-group select{width:100%;padding:.6rem .8rem;border:1px solid var(--border);border-radius:8px;outline:none;background:#fff}
.form-group select:focus{border-color:var(--primary)}
.form-group textarea{width:100%;padding:.6rem .8rem;border:1px solid var(--border);border-radius:8px;outline:none;resize:vertical;min-height:80px}
.form-group textarea:focus{border-color:var(--primary)}

.file-drop{border:2px dashed var(--border);border-radius:var(--radius);padding:1.5rem;text-align:center;color:var(--muted);font-size:.85rem;cursor:pointer;transition:all .2s ease;margin-top:.5rem;background:#faf9f6}
.file-drop:hover, .file-drop.dragover{border-color:var(--primary);background:var(--secondary);color:var(--sec-fg)}
.file-drop input{display:none}
.file-name-label{display:none;color:var(--primary);font-size:0.8rem;font-weight:600;margin-top:0.4rem;text-align:center}

/* CNEB info panel */
.cneb-panel{background:linear-gradient(135deg,#f0fdf9,#e6f5f3);border:1px solid #a7f3d0;border-radius:var(--radius);padding:1rem;margin-bottom:1rem;font-size:.82rem}
.cneb-panel .cneb-title{font-weight:700;color:var(--primary);margin-bottom:.4rem;font-size:.85rem}
.cneb-tag{display:inline-block;background:var(--primary);color:#fff;border-radius:20px;padding:.15rem .6rem;font-size:.72rem;font-weight:600;margin:.15rem .1rem;cursor:pointer;transition:opacity .15s}
.cneb-tag:hover{opacity:.8}

/* Output - rendered HTML */
.output-rendered{background:#fff;border:1px solid #a7f3d0;border-radius:var(--radius);padding:1.5rem 2rem;margin-top:1rem;font-size:.9rem;line-height:1.6;max-height:600px;overflow-y:auto;scroll-behavior:smooth;}
.output-rendered h2{color:var(--primary);font-size:1rem;font-weight:700;border-bottom:2px solid var(--secondary);padding-bottom:.3rem;margin:1.2rem 0 .5rem}
.output-rendered table{width:100%;border-collapse:collapse;font-size:.82rem;margin:.5rem 0}
.output-rendered th{background:var(--primary);color:#fff;padding:.5rem .7rem;text-align:left;font-weight:600}
.output-rendered td{border:1px solid var(--border);padding:.5rem .7rem;vertical-align:top}
.output-rendered tr:nth-child(even) td{background:#f8fffe}
.output-rendered ul{padding-left:1.2rem;margin:.3rem 0}
.output-rendered li{margin:.2rem 0}

/* Loading animation */
.loading{display:inline-block;width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.gen-loading{display:flex;align-items:center;gap:.8rem;padding:1.5rem;background:var(--secondary);border-radius:var(--radius);font-size:.9rem;color:var(--sec-fg);font-weight:600;margin-top:1rem}

/* Mobile & Chat */
.menu-toggle{display:none;position:fixed;top:.8rem;left:.8rem;z-index:60;background:var(--primary);color:#fff;border:none;border-radius:8px;width:40px;height:40px;font-size:1.2rem}
@media(max-width:768px){
  .sidebar{transform:translateX(-100%)}
  .sidebar.open{transform:translateX(0)}
  .main{margin-left:0;padding:1rem}
  .menu-toggle{display:flex;align-items:center;justify-content:center}
}
.hidden{display:none!important}

.chat-msg{display:flex;gap:.5rem;align-items:flex-start;margin-bottom:1rem;}
.chat-msg.user{flex-direction:row-reverse}
.chat-avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0}
.chat-msg.ai .chat-avatar{background:var(--primary);color:#fff}
.chat-msg.user .chat-avatar{background:var(--accent);color:#fff}
.chat-bubble{max-width:80%;padding:.6rem 1rem;border-radius:16px;font-size:.85rem;line-height:1.6}
.ai-bubble{background:var(--secondary);color:var(--fg);border-bottom-left-radius:4px}
.user-bubble{background:var(--primary);color:#fff;border-bottom-right-radius:4px}
</style>
</head>
<body>

<div id="authPage" class="auth-page">
  <div class="auth-box">
    <div class="auth-logo">N</div>
    <h1>Neurosim</h1>
    <p class="subtitle">Planificador de Clases ‚Äì CNEB</p>
    <p class="desc">Genera sesiones, unidades did√°cticas y planificaci√≥n anual alineadas al Curr√≠culo Nacional de Educaci√≥n B√°sica para secundaria.</p>
    <div class="auth-card">
      <h2>üîê Iniciar sesi√≥n</h2>
      <form id="loginForm" onsubmit="enterApp(event)">
        <div class="form-group">
          <label>Correo electr√≥nico</label>
          <input type="email" id="loginEmail" placeholder="correo@ejemplo.com" required>
        </div>
        <div class="form-group">
          <label>Contrase√±a</label>
          <input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
        </div>
        <button type="submit" class="btn btn-primary" style="margin-top:.5rem">Entrar ‚Üí</button>
      </form>
      <div class="divider">o</div>
      <button class="btn btn-outline" onclick="enterApp()">Acceder como invitado</button>
    </div>
  </div>
</div>

<div id="appShell" class="app hidden">
  <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>

  <aside class="sidebar" id="sidebar">
    <div class="logo"><div class="logo-icon">N</div><span>Neurosim</span></div>
    <nav>
      <a href="#" id="nav-dashboard" class="active" onclick="showPage('dashboard',this)">üìä Dashboard</a>
      <a href="#" id="nav-sesion" onclick="showPage('sesion',this)">üìù Sesi√≥n de Aprendizaje</a>
      <a href="#" id="nav-unidad" onclick="showPage('unidad',this)">üìö Unidad Did√°ctica</a>
      <a href="#" id="nav-planificacion" onclick="showPage('planificacion',this)">üìÖ Planificaci√≥n Anual</a>
      <a href="#" id="nav-documentos" onclick="showPage('documentos',this)">üìÅ Mis Documentos</a>
      <a href="#" id="nav-asistente" onclick="showPage('asistente',this)">ü§ñ Asistente IA</a>
      <button onclick="logout()" style="margin-top:auto;color:#f87171">üö™ Cerrar sesi√≥n</button>
    </nav>
    <div class="user-area" style="display:flex;flex-direction:column;gap:.5rem">
      <div>üë§ <span id="userName">Docente</span></div>
      <div style="font-size: 0.75rem; color: #5eead4;">‚ú® Motor Local Activo</div>
    </div>
  </aside>

  <div class="main">
    <div id="page-dashboard">
      <h1>¬°Bienvenido, <span id="welcomeName">Docente</span>! üëã</h1>
      <p class="page-desc">Panel de planificaci√≥n pedag√≥gica ‚Äì CNEB Secundaria</p>
      <div class="stats">
        <div class="stat-card"><div class="stat-icon">üìÑ</div><div><div class="val" id="statDocs">0</div><div class="lbl">Documentos</div></div></div>
        <div class="stat-card"><div class="stat-icon">üìù</div><div><div class="val" id="statSes">0</div><div class="lbl">Sesiones</div></div></div>
        <div class="stat-card"><div class="stat-icon">üìö</div><div><div class="val" id="statUni">0</div><div class="lbl">Unidades</div></div></div>
        <div class="stat-card"><div class="stat-icon">üìÖ</div><div><div class="val" id="statPlan">0</div><div class="lbl">Planificaciones</div></div></div>
      </div>
      <div class="quick-actions">
        <button class="qa-btn" onclick="showPage('sesion',document.getElementById('nav-sesion'))"><div class="icon">üìù</div>Nueva Sesi√≥n</button>
        <button class="qa-btn" onclick="showPage('unidad',document.getElementById('nav-unidad'))"><div class="icon">üìö</div>Nueva Unidad</button>
        <button class="qa-btn" onclick="showPage('planificacion',document.getElementById('nav-planificacion'))"><div class="icon">üìÖ</div>Plan Anual</button>
      </div>
    </div>

    <div id="page-sesion" class="hidden">
      <h1>üìù Sesi√≥n de Aprendizaje</h1>
      <div class="card">
        <h3>Datos de la sesi√≥n</h3>
        
        <div class="form-group">
          <label>Plantilla o Formato Base (Word)</label>
          <div class="file-drop" 
               onclick="document.getElementById('sesFile').click()"
               ondragover="event.preventDefault(); this.classList.add('dragover')"
               ondragleave="this.classList.remove('dragover')"
               ondrop="event.preventDefault(); this.classList.remove('dragover'); const inp=document.getElementById('sesFile'); inp.files=event.dataTransfer.files; showFileName(inp, 'sesFileName')">
            üìÑ Haz clic o arrastra tu formato base (.docx) aqu√≠.
            <input type="file" id="sesFile" accept=".docx" onchange="showFileName(this, 'sesFileName')">
          </div>
          <div id="sesFileName" class="file-name-label"></div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>√Årea Curricular</label>
            <select id="sesArea" onchange="onAreaChange('ses')">
              <option>Comunicaci√≥n</option>
              <option>Matem√°tica</option>
              <option>Ciencia y Tecnolog√≠a</option>
              <option>Ciencias Sociales</option>
              <option>Desarrollo Personal, Ciudadan√≠a y C√≠vica (DPCC)</option>
              <option>Educaci√≥n para el Trabajo (EPT)</option>
              <option>Ingl√©s</option>
              <option>Arte y Cultura</option>
              <option>Educaci√≥n F√≠sica</option>
              <option>Educaci√≥n Religiosa</option>
            </select>
          </div>
          <div class="form-group">
            <label>Grado</label>
            <select id="sesGrado" onchange="updateDesempenoAutomatico()">
              <option>1¬∞ Secundaria</option><option>2¬∞ Secundaria</option><option>3¬∞ Secundaria</option>
              <option>4¬∞ Secundaria</option><option>5¬∞ Secundaria</option>
            </select>
          </div>
        </div>

        <div id="sesCnebPanel" class="cneb-panel">
          <div class="cneb-title">üìã Competencias CNEB del √°rea (haz clic)</div>
          <div id="sesCnebCompetencias"></div>
        </div>

        <div class="form-group"><label>T√≠tulo de la sesi√≥n</label><input id="sesTitulo" placeholder="Ej: Analizamos textos expositivos..."></div>
        <div class="form-group"><label>Competencia</label><select id="sesCompetencia" onchange="onCompetenciaChange('ses')"><option value="">-- Selecciona --</option></select></div>
        <div class="form-group"><label>Capacidades</label><div id="sesCapacidades" style="font-size:.85rem;color:var(--muted);">Selecciona un √°rea y competencia</div></div>
        
        <div class="form-group">
          <label>Desempe√±o precisado (Generado autom√°ticamente - Editable)</label>
          <textarea id="sesDesempeno" style="min-height:60px" placeholder="El desempe√±o se autocompletar√° aqu√≠ al elegir Grado y Competencia..."></textarea>
        </div>
        
        <div style="margin-top:1rem;display:flex;gap:1rem;align-items:center;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="generarSesionLocal()" style="width:auto">‚ú® Generar Sesi√≥n con IA (Local)</button>
          <button id="btnExportSes" class="btn btn-success" onclick="exportToWord('sesOutput', 'Sesion_de_Aprendizaje')">üì• Descargar en Word</button>
        </div>
      </div>
      <div id="sesOutput"></div>
    </div>

    <div id="page-unidad" class="hidden">
      <h1>üìö Unidad Did√°ctica</h1>
      <div class="card">
        <h3>Datos de la unidad</h3>
        <div class="form-group">
          <label>Plantilla o Formato Base (Word)</label>
          <div class="file-drop" 
               onclick="document.getElementById('uniFile').click()"
               ondragover="event.preventDefault(); this.classList.add('dragover')"
               ondragleave="this.classList.remove('dragover')"
               ondrop="event.preventDefault(); this.classList.remove('dragover'); const inp=document.getElementById('uniFile'); inp.files=event.dataTransfer.files; showFileName(inp, 'uniFileName')">
            üìÑ Haz clic o arrastra tu formato base (.docx) aqu√≠.
            <input type="file" id="uniFile" accept=".docx" onchange="showFileName(this, 'uniFileName')">
          </div>
          <div id="uniFileName" class="file-name-label"></div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>√Årea Curricular</label>
            <select id="uniArea" onchange="onAreaChange('uni')">
              <option>Comunicaci√≥n</option><option>Matem√°tica</option><option>Ciencia y Tecnolog√≠a</option>
              <option>Ciencias Sociales</option><option>Desarrollo Personal, Ciudadan√≠a y C√≠vica (DPCC)</option>
              <option>Educaci√≥n para el Trabajo (EPT)</option><option>Ingl√©s</option>
              <option>Arte y Cultura</option><option>Educaci√≥n F√≠sica</option><option>Educaci√≥n Religiosa</option>
            </select>
          </div>
        </div>

        <div id="uniCnebPanel" class="cneb-panel"><div class="cneb-title">üìã Competencias CNEB (haz clic para agregar)</div><div id="uniCnebCompetencias"></div></div>

        <div class="form-group"><label>T√≠tulo de la Unidad</label><input id="uniTitulo" placeholder="Ej: Fomentamos el cuidado ambiental..."></div>
        <div class="form-group"><label>Competencias a trabajar</label><textarea id="uniCompetencias" style="min-height:70px"></textarea></div>
        
        <div style="margin-top:1rem;display:flex;gap:1rem;align-items:center;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="generarUnidadLocal()" style="width:auto">‚ú® Generar Unidad con IA (Local)</button>
          <button id="btnExportUni" class="btn btn-success" onclick="exportToWord('uniOutput', 'Unidad_Didactica')">üì• Descargar en Word</button>
        </div>
      </div>
      <div id="uniOutput"></div>
    </div>

    <div id="page-planificacion" class="hidden">
      <h1>üìÖ Planificaci√≥n Curricular Anual</h1>
      <div class="card">
        <h3>Datos generales</h3>
        <div class="form-group">
          <label>Plantilla o Formato Base (Word)</label>
          <div class="file-drop" 
               onclick="document.getElementById('planFile').click()"
               ondragover="event.preventDefault(); this.classList.add('dragover')"
               ondragleave="this.classList.remove('dragover')"
               ondrop="event.preventDefault(); this.classList.remove('dragover'); const inp=document.getElementById('planFile'); inp.files=event.dataTransfer.files; showFileName(inp, 'planFileName')">
            üìÑ Haz clic o arrastra tu formato base (.docx) aqu√≠.
            <input type="file" id="planFile" accept=".docx" onchange="showFileName(this, 'planFileName')">
          </div>
          <div id="planFileName" class="file-name-label"></div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>√Årea Curricular</label>
            <select id="planArea" onchange="onAreaChange('plan')">
              <option>Comunicaci√≥n</option><option>Matem√°tica</option><option>Ciencia y Tecnolog√≠a</option>
              <option>Ciencias Sociales</option><option>Desarrollo Personal, Ciudadan√≠a y C√≠vica (DPCC)</option>
              <option>Educaci√≥n para el Trabajo (EPT)</option><option>Ingl√©s</option>
              <option>Arte y Cultura</option><option>Educaci√≥n F√≠sica</option><option>Educaci√≥n Religiosa</option>
            </select>
          </div>
        </div>

        <div id="planCnebPanel" class="cneb-panel"><div class="cneb-title">üìã Competencias CNEB (haz clic para agregar)</div><div id="planCnebCompetencias"></div></div>

        <div class="form-group"><label>Competencias del √°rea</label><textarea id="planCompetencias" style="min-height:70px"></textarea></div>
        
        <div style="margin-top:1rem;display:flex;gap:1rem;align-items:center;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="generarPlanAnualLocal()" style="width:auto">‚ú® Generar Planificaci√≥n con IA (Local)</button>
          <button id="btnExportPlan" class="btn btn-success" onclick="exportToWord('planOutput', 'Planificacion_Anual')">üì• Descargar en Word</button>
        </div>
      </div>
      <div id="planOutput"></div>
    </div>

    <div id="page-documentos" class="hidden"><h1>üìÅ Mis Documentos</h1><div class="card"><p style="color:var(--muted)">Aqu√≠ aparecer√°n tus documentos guardados en futuras versiones.</p></div></div>
    
    <div id="page-asistente" class="hidden">
      <h1>ü§ñ Asistente Pedag√≥gico IA</h1>
      <div class="card" style="height:400px;display:flex;flex-direction:column">
        <div id="chatMessages" style="flex:1;overflow-y:auto;padding:1rem;scroll-behavior:smooth;">
          <div class="chat-msg ai"><div class="chat-avatar">ü§ñ</div><div class="chat-bubble ai-bubble">¬°Hola! Soy tu asistente pedag√≥gico. ¬øEn qu√© te puedo ayudar hoy con el CNEB?</div></div>
        </div>
        <div style="display:flex;gap:.5rem;padding:1rem;border-top:1px solid var(--border)">
          <input id="chatInput" style="flex:1" placeholder="Escribe tu consulta aqu√≠..." onkeydown="if(event.key==='Enter')sendChatLocal()">
          <button class="btn btn-primary" onclick="sendChatLocal()" style="width:auto">Enviar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// --- √ÅREAS, COMPETENCIAS Y CAPACIDADES CNEB SECUNDARIA COMPLETAS ---
const areasCNEB = {
  "Comunicaci√≥n": [
    { name: "Se comunica oralmente en su lengua materna", caps: ["Obtiene informaci√≥n del texto oral", "Infiere e interpreta informaci√≥n del texto oral", "Adec√∫a, organiza y desarrolla las ideas", "Utiliza recursos no verbales", "Interact√∫a estrat√©gicamente", "Reflexiona y eval√∫a"] },
    { name: "Lee diversos tipos de textos escritos en lengua materna", caps: ["Obtiene informaci√≥n del texto escrito", "Infiere e interpreta informaci√≥n del texto", "Reflexiona y eval√∫a la forma, el contenido y contexto"] },
    { name: "Escribe diversos tipos de textos en lengua materna", caps: ["Adec√∫a el texto a la situaci√≥n comunicativa", "Organiza y desarrolla las ideas", "Utiliza convenciones del lenguaje escrito", "Reflexiona y eval√∫a"] }
  ],
  "Matem√°tica": [
    { name: "Resuelve problemas de cantidad", caps: ["Traduce cantidades a expresiones", "Comunica su comprensi√≥n", "Usa estrategias y procedimientos", "Argumenta afirmaciones"] },
    { name: "Resuelve problemas de regularidad, equivalencia y cambio", caps: ["Traduce datos a expresiones", "Comunica su comprensi√≥n", "Usa estrategias y procedimientos", "Argumenta afirmaciones"] },
    { name: "Resuelve problemas de forma, movimiento y localizaci√≥n", caps: ["Modela objetos con formas", "Comunica su comprensi√≥n", "Usa estrategias para medir", "Argumenta afirmaciones"] },
    { name: "Resuelve problemas de gesti√≥n de datos e incertidumbre", caps: ["Representa datos", "Comunica su comprensi√≥n", "Usa estrategias para recopilar", "Sustenta conclusiones"] }
  ],
  "Ciencia y Tecnolog√≠a": [
    { name: "Indaga mediante m√©todos cient√≠ficos", caps: ["Problematiza situaciones", "Dise√±a estrategias", "Genera y registra datos", "Analiza datos", "Eval√∫a y comunica"] },
    { name: "Explica el mundo f√≠sico", caps: ["Comprende y usa conocimientos", "Eval√∫a las implicancias"] },
    { name: "Dise√±a y construye soluciones tecnol√≥gicas", caps: ["Determina una alternativa", "Dise√±a la alternativa", "Implementa y valida", "Eval√∫a y comunica"] }
  ],
  "Ciencias Sociales": [
    { name: "Construye interpretaciones hist√≥ricas", caps: ["Interpreta fuentes", "Comprende el tiempo", "Elabora explicaciones"] },
    { name: "Gestiona responsablemente el espacio", caps: ["Comprende las relaciones", "Maneja fuentes", "Genera acciones"] },
    { name: "Gestiona responsablemente los recursos econ√≥micos", caps: ["Comprende las relaciones", "Toma decisiones"] }
  ],
  "Desarrollo Personal, Ciudadan√≠a y C√≠vica (DPCC)": [
    { name: "Construye su identidad", caps: ["Se valora a s√≠ mismo", "Autorregula sus emociones", "Reflexiona √©ticamente", "Vive su sexualidad"] },
    { name: "Convive y participa democr√°ticamente", caps: ["Interact√∫a con personas", "Construye normas", "Maneja conflictos", "Delibera", "Participa en acciones"] }
  ],
  "Educaci√≥n para el Trabajo (EPT)": [
    { name: "Gestiona proyectos de emprendimiento", caps: ["Crea propuestas", "Aplica habilidades", "Trabaja cooperativamente", "Eval√∫a resultados"] }
  ],
  "Ingl√©s": [
    { name: "Se comunica oralmente en ingl√©s", caps: ["Obtiene informaci√≥n", "Infiere e interpreta", "Adec√∫a y organiza", "Utiliza recursos", "Interact√∫a", "Reflexiona"] },
    { name: "Lee diversos tipos de textos en ingl√©s", caps: ["Obtiene informaci√≥n", "Infiere e interpreta", "Reflexiona y eval√∫a"] },
    { name: "Escribe diversos tipos de textos en ingl√©s", caps: ["Adec√∫a el texto", "Organiza ideas", "Utiliza convenciones", "Reflexiona y eval√∫a"] }
  ],
  "Arte y Cultura": [
    { name: "Aprecia de manera cr√≠tica", caps: ["Percibe manifestaciones", "Contextualiza", "Reflexiona"] },
    { name: "Crea proyectos", caps: ["Explora y experimenta", "Aplica procesos", "Eval√∫a y comunica"] }
  ],
  "Educaci√≥n F√≠sica": [
    { name: "Se desenvuelve de manera aut√≥noma", caps: ["Comprende su cuerpo", "Se expresa corporalmente"] },
    { name: "Asume una vida saludable", caps: ["Comprende relaciones", "Incorpora pr√°cticas"] },
    { name: "Interact√∫a a trav√©s de sus habilidades", caps: ["Se relaciona", "Crea y aplica estrategias"] }
  ],
  "Educaci√≥n Religiosa": [
    { name: "Construye su identidad como persona...", caps: ["Conoce a Dios", "Cultiva y valora"] },
    { name: "Asume la experiencia del encuentro...", caps: ["Transforma su entorno", "Act√∫a coherentemente"] }
  ]
};

// --- NAVEGACI√ìN Y UI ---
function enterApp(e) {
  if (e) e.preventDefault();
  document.getElementById('authPage').classList.add('hidden');
  document.getElementById('appShell').classList.remove('hidden');
  onAreaChange('ses'); onAreaChange('uni'); onAreaChange('plan');
}
function logout() {
  document.getElementById('appShell').classList.add('hidden');
  document.getElementById('authPage').classList.remove('hidden');
}
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
function showPage(pageId, navEl) {
  document.querySelectorAll('.main > div').forEach(el => el.classList.add('hidden'));
  document.getElementById('page-' + pageId).classList.remove('hidden');
  document.querySelectorAll('.sidebar nav a').forEach(el => el.classList.remove('active'));
  if (navEl) navEl.classList.add('active');
  if (window.innerWidth <= 768) toggleSidebar();
}

// --- LOGICA DE FORMULARIOS ---
function onAreaChange(prefix) {
  const area = document.getElementById(prefix + 'Area').value;
  const comps = areasCNEB[area] || [];
  if (prefix === 'ses') {
    const sel = document.getElementById('sesCompetencia');
    sel.innerHTML = '<option value="">-- Selecciona --</option>';
    comps.forEach((c, i) => { sel.innerHTML += `<option value="${i}">${c.name}</option>`; });
    document.getElementById('sesCnebCompetencias').innerHTML = comps.map((c, i) => `<span class="cneb-tag" onclick="selectCompetencia(${i})">${c.name}</span>`).join('');
    document.getElementById('sesCapacidades').innerHTML = 'Selecciona una competencia';
    document.getElementById('sesDesempeno').value = '';
  } else {
    document.getElementById(prefix + 'CnebCompetencias').innerHTML = comps.map(c => `<span class="cneb-tag" onclick="addCompetenciaToTextarea('${prefix}Competencias', '${c.name}')">${c.name}</span>`).join('');
  }
}

function selectCompetencia(index) {
  document.getElementById('sesCompetencia').value = index;
  onCompetenciaChange('ses');
}
function addCompetenciaToTextarea(id, compName) {
  const ta = document.getElementById(id);
  if (!ta.value.includes(compName)) ta.value = ta.value ? ta.value + '\n- ' + compName : '- ' + compName;
}

function onCompetenciaChange(prefix) {
  const area = document.getElementById(prefix + 'Area').value;
  const compIdx = document.getElementById(prefix + 'Competencia').value;
  if (compIdx === '') {
    document.getElementById(prefix + 'Capacidades').innerHTML = 'Selecciona una competencia';
    return;
  }
  const caps = areasCNEB[area][compIdx].caps;
  document.getElementById(prefix + 'Capacidades').innerHTML = caps.map(cap => `<label style="display:block;margin-bottom:.4rem"><input type="checkbox" checked style="margin-right:.5rem"> ${cap}</label>`).join('');
  
  if(prefix === 'ses') updateDesempenoAutomatico();
}

function updateDesempenoAutomatico() {
  const compSelect = document.getElementById('sesCompetencia');
  if(!compSelect || compSelect.value === '') return;
  
  const competenciaName = compSelect.options[compSelect.selectedIndex].text;
  const grado = document.getElementById('sesGrado').value;
  
  let nivelComplejidad = "contenidos de estructura simple";
  if(grado.includes("3") || grado.includes("4")) nivelComplejidad = "contenidos de estructura compleja y variada";
  if(grado.includes("5")) nivelComplejidad = "temas especializados con estructuras complejas y posturas cr√≠ticas";

  let desempe√±oSugerido = `Identifica, explica y aplica estrategias clave relacionadas a la competencia '${competenciaName}', adaptando su proceso cognitivo a las exigencias de los estudiantes de ${grado}, evidenciando el an√°lisis y comprensi√≥n de ${nivelComplejidad}.`;
  
  document.getElementById('sesDesempeno').value = desempe√±oSugerido;
}

// --- ARCHIVOS ---
function showFileName(input, labelId) {
  const label = document.getElementById(labelId);
  if (input.files && input.files.length > 0) {
    label.textContent = "‚úÖ Archivo cargado: " + input.files[0].name;
    label.style.display = "block";
  } else {
    label.style.display = "none";
  }
}

// --- EXPORTAR A WORD (CSS COMPACTO MANTENIDO) ---
function exportToWord(elementId, filename) {
  const contentEl = document.getElementById(elementId).querySelector('.output-rendered');
  if (!contentEl) return alert("No hay documento generado para exportar.");

  let rawHTML = contentEl.innerHTML
      .replace(/```html/gi, '').replace(/```/g, '')
      .replace(/<p><br><\/p>/g, '').replace(/<p>&nbsp;<\/p>/g, '')
      .replace(/<br>\s*<br>/g, '<br>').trim();

  // Estilos muy compactos para Word
  const styles = `
    <style>
      body { font-family: 'Arial', sans-serif; line-height: 1.15; color: #000; margin: 0; padding: 10px; font-size: 11pt; }
      h2 { font-size: 13pt; color: #0056b3; border-bottom: 1px solid #a0cffc; margin-top: 12px; margin-bottom: 6px; }
      table { width: 100%; border-collapse: collapse; margin-top: 5px; margin-bottom: 10px; font-size: 10.5pt; }
      table, th, td { border: 1px solid #666; }
      th, td { padding: 4px 6px; text-align: left; vertical-align: top; }
      th { background-color: #e9f5ff; font-weight: bold; color: #004085; }
      ul { margin-left: 20px; padding-left: 0; margin-top: 3px; margin-bottom: 3px; }
      li { margin-bottom: 2px; }
      p { margin-top: 2px; margin-bottom: 6px; }
    </style>
  `;

  const html = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'>" + styles + "</head><body>" + rawHTML + "</body></html>";
  const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
  
  const downloadLink = document.createElement("a");
  downloadLink.href = URL.createObjectURL(blob);
  downloadLink.download = (filename || 'documento') + '.doc';
  document.body.appendChild(downloadLink);
  downloadLink.click();
  document.body.removeChild(downloadLink);
  
  // Actualizar contador del dashboard
  let docCount = parseInt(document.getElementById('statDocs').innerText);
  document.getElementById('statDocs').innerText = docCount + 1;
}

// --- GENERADORES LOCALES (Adi√≥s error de conexi√≥n) ---
function generarSesionLocal() {
  const titulo = document.getElementById('sesTitulo').value || "Sesi√≥n de Aprendizaje";
  const area = document.getElementById('sesArea').value;
  const grado = document.getElementById('sesGrado').value;
  const compSelect = document.getElementById('sesCompetencia');
  const competencia = compSelect.options[compSelect.selectedIndex]?.text || "No especificada";
  const desempe√±o = document.getElementById('sesDesempeno').value;
  const capNodes = document.querySelectorAll('#sesCapacidades input:checked');
  let capacidades = Array.from(capNodes).map(n => `<li>${n.parentNode.textContent.trim()}</li>`).join('');

  const output = document.getElementById('sesOutput');
  const btnExport = document.getElementById('btnExportSes');
  btnExport.style.display = 'none';
  output.innerHTML = '<div class="gen-loading"><div class="loading"></div>Estructurando sesi√≥n...</div>';

  setTimeout(() => {
    const html = `
      <h2>1. Datos Informativos</h2>
      <table>
        <tr><th>√Årea Curricular</th><td>${area}</td><th>Grado</th><td>${grado}</td></tr>
        <tr><th>T√≠tulo de Sesi√≥n</th><td colspan="3">${titulo}</td></tr>
      </table>
      <h2>2. Prop√≥sitos de Aprendizaje</h2>
      <table>
        <tr><th>Competencia</th><th>Capacidades</th><th>Desempe√±o Precisado</th></tr>
        <tr><td><strong>${competencia}</strong></td><td><ul>${capacidades}</ul></td><td>${desempe√±o}</td></tr>
      </table>
      <h2>3. Secuencia Did√°ctica</h2>
      <table>
        <tr><th style="width:15%">Momentos</th><th>Actividades / Estrategias</th><th style="width:15%">Tiempo</th></tr>
        <tr><td><strong>INICIO</strong></td><td><ul><li>Motivaci√≥n y problematizaci√≥n.</li><li>Recojo de saberes previos.</li><li>Comunicaci√≥n del prop√≥sito.</li></ul></td><td>15 min</td></tr>
        <tr><td><strong>DESARROLLO</strong></td><td><ul><li>Gesti√≥n y acompa√±amiento.</li><li>Aplicaci√≥n de estrategias vinculadas a la competencia.</li><li>Retroalimentaci√≥n formativa.</li></ul></td><td>60 min</td></tr>
        <tr><td><strong>CIERRE</strong></td><td><ul><li>Evaluaci√≥n y conclusiones.</li><li>Metacognici√≥n.</li></ul></td><td>15 min</td></tr>
      </table>
      <h2>4. Evaluaci√≥n</h2>
      <table><tr><th>Criterios</th><th>Instrumento</th></tr><tr><td>Logro del desempe√±o: ${desempe√±o}</td><td>Lista de Cotejo</td></tr></table>
    `;
    output.innerHTML = `<div class="output-rendered">${html}</div>`;
    btnExport.style.display = 'inline-flex';
    document.getElementById('statSes').innerText = parseInt(document.getElementById('statSes').innerText) + 1;
    output.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 1000);
}

function generarUnidadLocal() {
  const titulo = document.getElementById('uniTitulo').value || "Unidad Did√°ctica";
  const area = document.getElementById('uniArea').value;
  const compsText = document.getElementById('uniCompetencias').value.replace(/\n/g, '<br>');
  const output = document.getElementById('uniOutput');
  const btnExport = document.getElementById('btnExportUni');
  btnExport.style.display = 'none';
  output.innerHTML = '<div class="gen-loading"><div class="loading"></div>Generando unidad...</div>';

  setTimeout(() => {
    const html = `
      <h2>Datos de la Unidad Did√°ctica</h2>
      <table>
        <tr><th>√Årea Curricular</th><td>${area}</td><th>T√≠tulo</th><td>${titulo}</td></tr>
      </table>
      <h2>Competencias Seleccionadas</h2>
      <p>${compsText || 'No se seleccionaron competencias espec√≠ficas.'}</p>
      <h2>Situaci√≥n Significativa</h2>
      <p>Los estudiantes desarrollan el pensamiento cr√≠tico abordando problem√°ticas del contexto actual, aplicando las competencias del √°rea para proponer soluciones viables.</p>
      <h2>Secuencia de Sesiones</h2>
      <table>
        <tr><th>Sesi√≥n 1</th><td>Introducci√≥n y diagn√≥stico inicial.</td></tr>
        <tr><th>Sesi√≥n 2</th><td>Desarrollo te√≥rico-pr√°ctico del tema central.</td></tr>
        <tr><th>Sesi√≥n 3</th><td>Aplicaci√≥n de conocimientos y retroalimentaci√≥n.</td></tr>
        <tr><th>Sesi√≥n 4</th><td>Evaluaci√≥n final y socializaci√≥n de resultados.</td></tr>
      </table>
    `;
    output.innerHTML = `<div class="output-rendered">${html}</div>`;
    btnExport.style.display = 'inline-flex';
    document.getElementById('statUni').innerText = parseInt(document.getElementById('statUni').innerText) + 1;
  }, 1000);
}

function generarPlanAnualLocal() {
  const area = document.getElementById('planArea').value;
  const output = document.getElementById('planOutput');
  const btnExport = document.getElementById('btnExportPlan');
  btnExport.style.display = 'none';
  output.innerHTML = '<div class="gen-loading"><div class="loading"></div>Generando plan anual...</div>';

  setTimeout(() => {
    const html = `
      <h2>Planificaci√≥n Anual - ${area}</h2>
      <table><tr><th>√Årea Curricular</th><td>${area}</td><th>Ciclo/Grado</th><td>Secundaria</td></tr></table>
      <h2>Organizaci√≥n de las Unidades Did√°cticas</h2>
      <table>
        <tr><th>Bimestre</th><th>T√≠tulo de la Unidad</th><th>Semanas</th></tr>
        <tr><td>I Bimestre</td><td>Evaluaci√≥n diagn√≥stica y nivelaci√≥n</td><td>4 semanas</td></tr>
        <tr><td>I Bimestre</td><td>Desarrollando habilidades iniciales</td><td>5 semanas</td></tr>
        <tr><td>II Bimestre</td><td>Profundizaci√≥n y an√°lisis cr√≠tico</td><td>9 semanas</td></tr>
        <tr><td>III Bimestre</td><td>Proyectos colaborativos</td><td>9 semanas</td></tr>
        <tr><td>IV Bimestre</td><td>Evaluaci√≥n sumativa y clausura</td><td>9 semanas</td></tr>
      </table>
    `;
    output.innerHTML = `<div class="output-rendered">${html}</div>`;
    btnExport.style.display = 'inline-flex';
    document.getElementById('statPlan').innerText = parseInt(document.getElementById('statPlan').innerText) + 1;
  }, 1000);
}

// --- CHAT LOCAL ---
function scrollToBottomChat() {
  const container = document.getElementById('chatMessages');
  container.scrollTop = container.scrollHeight;
}
function sendChatLocal() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;
  const container = document.getElementById('chatMessages');
  container.innerHTML += `<div class="chat-msg user"><div class="chat-avatar">üë§</div><div class="chat-bubble user-bubble">${text}</div></div>`;
  input.value = '';
  scrollToBottomChat(); 
  
  const typingId = 'typing-' + Date.now();
  container.innerHTML += `<div id="${typingId}" class="chat-msg ai"><div class="chat-avatar">ü§ñ</div><div class="chat-bubble ai-bubble"><div class="loading" style="width:12px;height:12px;border-width:1.5px"></div></div></div>`;
  scrollToBottomChat(); 

  setTimeout(() => {
    document.getElementById(typingId).remove();
    const resp = `Esta es una respuesta simulada de la IA en modo local. Has preguntado: "<em>${text}</em>". Recuerda que la exportaci√≥n de documentos ya no arrojar√° error de conexi√≥n.`;
    container.innerHTML += `<div class="chat-msg ai"><div class="chat-avatar">ü§ñ</div><div class="chat-bubble ai-bubble">${resp}</div></div>`;
    scrollToBottomChat();
  }, 1200);
}
</script>
</body>
</html>
